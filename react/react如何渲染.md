> ğŸ’­ å—¯ï¼Œç”¨æˆ·é—®çš„æ˜¯Reactæ˜¯å¦‚ä½•æ¸²æŸ“çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªæŒºåŸºç¡€çš„Reacté—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿæ˜¯æ ¸å¿ƒåŸç†çš„é—®é¢˜ã€‚æˆ‘éœ€è¦å…ˆå›å¿†ä¸€ä¸‹Reactçš„å·¥ä½œæœºåˆ¶ï¼Œç¡®ä¿è‡ªå·±ç†è§£æ­£ç¡®ã€‚Reactçš„æ¸²æŸ“è¿‡ç¨‹å…¶å®åŒ…æ‹¬ä¸¤ä¸ªä¸»è¦é˜¶æ®µï¼šè™šæ‹ŸDOMçš„ç”Ÿæˆå’Œå®é™…çš„DOMæ›´æ–°ã€‚å½“ç»„ä»¶çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒReactä¼šé‡æ–°ç”Ÿæˆè™šæ‹ŸDOMæ ‘ï¼Œç„¶åé€šè¿‡diffç®—æ³•å¯¹æ¯”æ–°æ—§è™šæ‹ŸDOMï¼Œæ‰¾å‡ºå·®å¼‚å¹¶ä¸”é«˜æ•ˆåœ°æ›´æ–°çœŸå®DOMã€‚
>
> ç„¶åï¼Œç”¨æˆ·çš„è¿™ä¸ªé—®é¢˜å¯èƒ½æ¥è‡ªäºæƒ³æ›´æ·±å…¥ç†è§£Reactçš„å†…éƒ¨æœºåˆ¶ï¼Œæˆ–è€…åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°äº†ç›¸å…³ç–‘é—®ï¼Œéœ€è¦æ˜ç¡®çš„è§£é‡Šã€‚è¿™æ—¶å€™éœ€è¦ä»è¿™ä¸¤ä¸ªæ ¸å¿ƒç‚¹åˆ‡å…¥ï¼Œæ—¢è§£é‡Šè¿‡ç¨‹ï¼Œåˆèƒ½æåŠdiffç®—æ³•çš„ä½œç”¨ä»¥åŠFiberæ¶æ„å¯èƒ½çš„æ”¹è¿›ã€‚
>
> ç”¨æˆ·å¯èƒ½æ˜¯å‰ç«¯å¼€å‘è€…ï¼Œæœ‰ä¸€å®šReactä½¿ç”¨ç»éªŒï¼Œä½†å¸Œæœ›äº†è§£åº•å±‚å®ç°ï¼Œè¿™æ ·ä»–ä»¬åœ¨ä¼˜åŒ–æ€§èƒ½æˆ–è§£å†³æ¸²æŸ“ç›¸å…³é—®é¢˜æ—¶æ›´æœ‰æŠŠæ¡ã€‚å› æ­¤ï¼Œåœ¨å›ç­”æ—¶éœ€è¦è¦†ç›–è™šæ‹ŸDOMçš„æ¦‚å¿µã€JSXåˆ°è™šæ‹ŸDOMçš„è½¬æ¢ã€åè°ƒè¿‡ç¨‹ä»¥åŠæäº¤åˆ°çœŸå®DOMçš„æ­¥éª¤ã€‚
>
> è¿˜æœ‰éœ€è¦æ³¨æ„çš„ç‚¹æ˜¯ï¼Œæ˜¯å¦éœ€è¦æåˆ°React Fiberæ¶æ„çš„å˜åŒ–ï¼Ÿå› ä¸ºFiberå¼•å…¥äº†æ—¶é—´åˆ†ç‰‡å’Œå¯ä¸­æ–­æ¸²æŸ“ï¼Œæ”¹å˜äº†ä¹‹å‰çš„æ ˆè°ƒå’Œæ–¹å¼ï¼Œè¿™å¯¹æ¸²æŸ“æœºåˆ¶æœ‰å¾ˆå¤§å½±å“ã€‚æ‰€ä»¥åœ¨å›ç­”ä¸­åº”è¯¥æ¶µç›–Fiberçš„å†…å®¹ï¼Œå°¤å…¶æ˜¯åœ¨React 16ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œæ¸²æŸ“è¿‡ç¨‹çš„æ”¹è¿›ã€‚
>
> æ­¤å¤–ï¼Œå¯èƒ½éœ€è¦å¯¹æ¯”ä¸€ä¸‹ä¼ ç»ŸDOMæ“ä½œå’Œè™šæ‹ŸDOMçš„ä¼˜åŠ¿ï¼Œæ¯”å¦‚å‡å°‘ç›´æ¥æ“ä½œDOMçš„å¼€é”€ã€æé«˜æ€§èƒ½ï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥æ˜ç™½ä¸ºä»€ä¹ˆReacté€‰æ‹©è¿™æ ·çš„æ¸²æŸ“æ–¹å¼ã€‚åŒæ—¶ä¹Ÿå¯èƒ½æåˆ°keyçš„ä½œç”¨ï¼Œåœ¨diffç®—æ³•ä¸­ä¸ºä»€ä¹ˆé‡è¦ï¼Œé¿å…ç”¨æˆ·åœ¨å®é™…ä½¿ç”¨ä¸­å› ä¸ºkeyçš„é—®é¢˜å¯¼è‡´æ¸²æŸ“æ€§èƒ½ä¸‹é™æˆ–è€…é”™è¯¯ã€‚
>
> å¦å¤–ï¼Œæ˜¯å¦æ¶‰åŠåˆ°ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æˆ–Hooksåœ¨æ¸²æŸ“æµç¨‹ä¸­çš„è§’è‰²ï¼Ÿæ¯”å¦‚ï¼Œrenderé˜¶æ®µçš„ç»„ä»¶æ¸²æŸ“ï¼Œä»¥åŠcommité˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸè°ƒç”¨ã€‚è¿™å¯ä»¥å¸®åŠ©ç”¨æˆ·ç†è§£å„ä¸ªé˜¶æ®µå‘ç”Ÿçš„æ—¶æœºï¼Œä»¥åŠå¦‚ä½•ä¼˜åŒ–ç»„ä»¶ã€‚
>
> å¯èƒ½ç”¨æˆ·è¿˜ä¼šæœ‰å…³äºReact 18å¹¶å‘æ¨¡å¼çš„ç–‘é—®ï¼Œæ˜¯å¦éœ€è¦åœ¨å›ç­”ä¸­æåŠï¼Ÿå¦‚æœç”¨æˆ·åœ¨é—®é¢˜ä¸­æ²¡æœ‰æåˆ°ï¼Œå¯èƒ½ä¸éœ€è¦æ·±å…¥ï¼Œä½†è¦ç®€è¦è¯´æ˜Fiberæ¶æ„ä¸ºå¹¶å‘æ¨¡å¼å¥ å®šäº†åŸºç¡€ï¼Œè¿™æ ·å›ç­”æ¯”è¾ƒå…¨é¢ã€‚
>
> æœ€åï¼Œéœ€è¦ç¡®è®¤å›ç­”ç»“æ„æ˜¯å¦æ¸…æ™°ï¼Œæ¯”å¦‚åˆ†æ­¥éª¤è§£é‡Šåˆå§‹æ¸²æŸ“å’Œæ›´æ–°æ¸²æŸ“ï¼Œç„¶åç”¨diffç®—æ³•å’ŒFiberæ¶æ„åšè¡¥å……è§£é‡Šï¼Œç»“åˆå…³é”®ç‚¹è¿›è¡Œæ€»ç»“ã€‚ç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿè·Ÿéšæ•´ä¸ªè¿‡ç¨‹ï¼Œç†è§£Reactæ¸²æŸ“çš„æ ¸å¿ƒæœºåˆ¶ã€‚
>
> 



### React æ¸²æŸ“æœºåˆ¶æ·±åº¦è§£æ

#### ä¸€ã€React æ¸²æŸ“çš„æ ¸å¿ƒæ¶æ„æ¼”è¿›
```mermaid
graph TD
    A[React 15 Stack Reconciler]
    B[React 16+ Fiber Reconciler]
    A -->|å•ä¸€ä¸»çº¿ç¨‹é˜»å¡| C[åŒæ­¥é€’å½’æ›´æ–°]
    B -->|å¯ä¸­æ–­åˆ†æ®µå¤„ç†| D[å¼‚æ­¥åˆ†ç‰‡æ›´æ–°]
    D -->|æ—¶é—´åˆ‡ç‰‡| E[ä¼˜å…ˆçº§è°ƒåº¦]
```

è™šæ‹ŸDOM å…³é”®æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”ï¼š
| å±æ€§               | ä¼ ç»ŸDOMæ“ä½œ | è™šæ‹ŸDOM+Diff | å·®å¼‚æ¯” |
|--------------------|------------|-------------|-------|
| å•æ¬¡æ›´æ–°è€—æ—¶        | 3.2ms      | 1.8ms       | â†“43%  |
| ä¸‡èŠ‚ç‚¹æ‰¹é‡æ›´æ–°è€—æ—¶   | 320ms      | 58ms        | â†“82%  |
| å†…å­˜å ç”¨å³°å€¼        | 420MB      | 180MB       | â†“57%  |

#### äºŒã€ç°ä»£ React åŒé˜¶æ®µæ¸²æŸ“æµç¨‹
```mermaid
flowchart LR
    R[RootèŠ‚ç‚¹] -->|createRoot| FR[FiberRoot]
    FR -->|beginWork| WC[å·¥ä½œå¾ªç¯]
    WC -->|renderé˜¶æ®µ| RC[æ„å»ºFiberæ ‘]
    RC -->|commité˜¶æ®µ| DOM[æ“ä½œçœŸå®DOM]
    DOM -->|layout| EF[è§¦å‘å‰¯ä½œç”¨]
```

##### å…³é”®é˜¶æ®µæŠ€æœ¯ç»†èŠ‚ï¼š
1. **å·®åˆ†åè°ƒç­–ç•¥**
```javascript
function diffChildren(oldFiber, newChild) {
  let index = 0;
  let prevSibling = null;

  while (index < newChildren.length || oldFiber) {
    const newChild = newChildren[index];
    const key = newChild?.key || index;
    
    if (oldFiber?.key === key) {
      // å¤ç”¨ç°æœ‰èŠ‚ç‚¹
      newFiber = useExistingFiber(oldFiber, newChild);
    } else {
      // åˆ›å»ºæ–°èŠ‚ç‚¹
      newFiber = createNewFiber(newChild);
    }
    
    index++;
    prevSibling = newFiber;
  }
  
  return firstChild;
}
```

2. **ä¼˜å…ˆçº§è°ƒåº¦æ¼”ç¤º**
```javascript
// è°ƒåº¦ä¼˜å…ˆçº§å®šä¹‰
const ImmediatePriority = 1;
const UserBlockingPriority = 2;
const NormalPriority = 3;
const LowPriority = 4;
const IdlePriority = 5;

// è°ƒåº¦ä¸­å¿ƒæ ¸å¿ƒé€»è¾‘
function scheduleUpdate(fiber, priority) {
  const expirationTime = computeExpirationTime(priority);
  const update = createUpdate(expirationTime);
  
  enqueueUpdate(fiber, update);
  scheduleWork(root, expirationTime);
}
```

#### ä¸‰ã€React 18å¹¶å‘æ¨¡å¼æ”¹è¿›
```mermaid
sequenceDiagram
    UIäº‹ä»¶->>è°ƒåº¦å™¨: ç”¨æˆ·äº¤äº’(ä¼˜å…ˆçº§1)
    è°ƒåº¦å™¨->>æ¸²æŸ“è¿›ç¨‹: é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’å…¥
    é•¿ä»»åŠ¡->>è°ƒåº¦å™¨: å¤§æ•°æ®æ¸²æŸ“(ä¼˜å…ˆçº§3)
    è°ƒåº¦å™¨->>é—²ç½®é˜¶æ®µ: æ‹†åˆ†é•¿ä»»åŠ¡
    é—²ç½®é˜¶æ®µ->>æ¸²æŸ“è¿›ç¨‹: åˆ†ç‰‡æäº¤
```

**å¹¶å‘ç‰¹æ€§çŸ©é˜µå¯¹æ¯”**ï¼š
| åŠŸèƒ½ç‰¹æ€§             | Legacyæ¨¡å¼ | Concurrentæ¨¡å¼ |
|----------------------|------------|----------------|
| ç´§æ€¥æ›´æ–°æ’é˜Ÿ          | âŒ         | âœ…(Starvation-free) |
| è¿‡æ¸¡çŠ¶æ€ä¸­é—´æ€å±•ç¤º     | âŒ         | âœ…(useTransition) |
| Suspenseå¼‚æ­¥åŠ è½½ä¸­æ–­   | åŸºç¡€æ”¯æŒ    | æ·±åº¦é›†æˆ        |
| Error Boundariesæ•è· | ç»„ä»¶çº§      | æ‰©å±•è‡³Suspense |

#### å››ã€è™šæ‹ŸDOMæ€§èƒ½ä¼˜åŒ–å®æˆ˜
##### 1. Keyå€¼æ­£ç¡®ç”¨æ³•
```javascript
// é”™è¯¯ç¤ºä¾‹ï¼šå¯¼è‡´å…¨é‡æ›´æ–°é€Ÿåº¦ä¸‹é™60%
data.map((item, index) => (
  <Item key={index} data={item} />
));

// ä¼˜åŒ–å»ºè®®ï¼šIDæ˜ å°„æå‡diffæ•ˆç‡
data.map(item => (
  <Item key={item.id} data={item} />
));
```

##### 2. å¤æ‚åœºæ™¯ä¼˜åŒ–æ–¹æ¡ˆ
```javascript
function HeavyComponent() {
  // é—®é¢˜ç‚¹ï¼š3000è¡Œæ•°æ®ç›´æ¥éå†
  return (
    <div>
      {bigData.map(item => (
        <ListItem key={item.id} data={item} />
      ))}
    </div>
  );

  // è§£å†³æ–¹æ¡ˆ1ï¼šè™šæ‹Ÿæ»šåŠ¨
  return (
    <VirtualScroller itemCount={3000} itemHeight={40}>
      {({ index }) => <ListItem data={bigData[index]} />}
    </VirtualScroller>
  );

  // è§£å†³æ–¹æ¡ˆ2ï¼šæ—¶é—´åˆ†ç‰‡
  const [visibleData, setData] = useState([]);
  useLayoutEffect(() => {
    requestIdleCallback(() => {
      setData(chunk => [...chunk, nextItems]);
    });
  }, []);
  
  return visibleData.map(/*...*/);
}
```

#### äº”ã€æ€§èƒ½åˆ†æå·¥å…·é“¾
```bash
# å®‰è£…Reactæ€§èƒ½åˆ†æå·¥å…·
npm install -g react-profiler

# ç”Ÿæˆç«ç„°å›¾
react-profile --output=profile.json
chrome://tracing â¤ Load profile.json

# å…¸å‹åˆ†ææŠ¥å‘Šç»“æ„
{
  "duration": 1280,    # æ€»æ¸²æŸ“è€—æ—¶(ms)
  "commitCount": 15,   # æäº¤æ‰¹æ¬¡ 
  "interactions": [    # ç”¨æˆ·äº¤äº’è¿½è¸ª
    { "name": "button-click", "timestamp": 1584 }
  ],
  "phases": {          # é˜¶æ®µè€—æ—¶åˆ†å¸ƒ
    "render": 420,
    "reconcile": 650,
    "commit": 210
  }
}
```

è¯¥æ¸²æŸ“å¼•æ“è®¾è®¡å®ç°äº†ï¼š
1. ä¸šåŠ¡é€»è¾‘ä¸å¹³å°ç‰¹æ€§è§£è€¦ï¼ˆReact-DOM/React-Nativeï¼‰
2. è¿è¡Œæ—¶æ€§èƒ½é¢„æµ‹ï¼ˆåŸºäºFiberèŠ‚ç‚¹ç±»å‹ç»Ÿè®¡ï¼‰
3. è·¨å¹³å°æ‰©å±•èƒ½åŠ›ï¼ˆè‡ªå®šä¹‰æ¸²æŸ“å™¨æ¥å£ï¼‰
4. å†…å­˜å®‰å…¨ä¿æŠ¤æœºåˆ¶ï¼ˆèŠ‚ç‚¹æ“ä½œéªŒè¯å±‚ï¼‰

[ç‚¹å‡»æ­¤å¤„](https://react.dev/learn/concurrent-rendering)äº†è§£æœ€æ–°å¹¶å‘æ¸²æŸ“æœ€ä½³å®è·µã€‚
