> ğŸ’­ å—¯ï¼Œç”¨æˆ·ç°åœ¨é—®çš„æ˜¯å…³äºå¦‚ä½•é€šè¿‡åå‘ç»§æ‰¿ï¼ˆHOC + Render Hijackingï¼‰æ¥æ‹¦æˆªå¹¶ä¿®æ”¹Reactç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚è¿™ä¸ªé—®é¢˜çœ‹èµ·æ¥æŒºé«˜çº§çš„ï¼Œå¯èƒ½ç”¨æˆ·å·²ç»æŒæ¡äº†åŸºæœ¬çš„HOCä½¿ç”¨ï¼Œç°åœ¨æƒ³æ·±å…¥ç†è§£å¦‚ä½•é€šè¿‡HOCæ¥æ§åˆ¶æˆ–ä¿®æ”¹å·²æœ‰ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸè¡Œä¸ºã€‚è¿™å¯èƒ½æ¶‰åŠåˆ°ç»„ä»¶çš„æ‰©å±•ã€æ€§èƒ½ç›‘æ§ã€æ—¥å¿—è®°å½•æˆ–è€…åœ¨æ¸²æŸ“å‰åšä¸€äº›æ•°æ®æ“ä½œã€‚
>
> é¦–å…ˆï¼Œæˆ‘éœ€è¦å›é¡¾ä¸€ä¸‹é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰çš„æ¦‚å¿µã€‚HOCæ˜¯Reactä¸­å¤ç”¨ç»„ä»¶é€»è¾‘çš„ä¸€ç§é«˜çº§æŠ€å·§ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªç»„ä»¶è¿”å›ä¸€ä¸ªæ–°çš„ç»„ä»¶ã€‚åå‘ç»§æ‰¿æ˜¯å…¶ä¸­ä¸€ç§å®ç°æ–¹å¼ï¼Œå®ƒè®©HOCç»§æ‰¿è¢«åŒ…è£¹çš„ç»„ä»¶ï¼Œä»è€Œå¯ä»¥è®¿é—®å…¶ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å’Œstateã€‚
>
> é‚£æ€ä¹ˆå…·ä½“æ‹¦æˆªç”Ÿå‘½å‘¨æœŸæ–¹æ³•å‘¢ï¼Ÿæ¯”å¦‚ï¼Œç”¨æˆ·å¯èƒ½æƒ³åœ¨ä¸€ä¸ªç»„ä»¶çš„componentDidMountä¸­æ·»åŠ ä¸€äº›é¢å¤–çš„é€»è¾‘ï¼Œæˆ–è€…ä¿®æ”¹å®ƒçš„renderè¾“å‡ºã€‚è¿™æ—¶å€™åå‘ç»§æ‰¿å°±æœ‰ç”¨äº†ã€‚æ¯”å¦‚ï¼ŒHOCå¯ä»¥è¦†ç›–è¢«åŒ…è£¹ç»„ä»¶çš„componentDidMountï¼Œå…ˆæ‰§è¡Œè‡ªå·±çš„é€»è¾‘ï¼Œå†è°ƒç”¨åŸå§‹æ–¹æ³•ã€‚è¿™åœ¨æ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æ§ã€æƒé™æ§åˆ¶ç­‰åœºæ™¯ä¸‹å¸¸ç”¨ã€‚
>
> ä½†æ˜¯éœ€è¦æ³¨æ„ç»§æ‰¿åçš„ç»„ä»¶èƒ½å¦æ­£ç¡®è®¿é—®åˆ°åŸç»„ä»¶çš„æ–¹æ³•å’ŒçŠ¶æ€ã€‚ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„é‡å†™éœ€è¦è€ƒè™‘è°ƒç”¨åŸæ–¹æ³•æ—¶çš„ä¸Šä¸‹æ–‡ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨superæ¥è°ƒç”¨åŸç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œæ¯”å¦‚super.componentDidMount()ã€‚åŒæ—¶ï¼Œè¿˜è¦å¤„ç†stateå¯èƒ½ä¼šè¢«è¦†ç›–çš„é—®é¢˜ï¼Œå¦‚æœæœ‰çš„è¯ã€‚
>
> æ¥ä¸‹æ¥æ˜¯å…³äºRender Hijackingï¼Œè¿™éƒ¨åˆ†åº”è¯¥æ˜¯ä¿®æ”¹æˆ–æ§åˆ¶ç»„ä»¶çš„æ¸²æŸ“è¾“å‡ºã€‚æ¯”å¦‚ï¼Œå¯ä»¥åœ¨HOCçš„renderæ–¹æ³•ä¸­æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦æ¸²æŸ“åŸç»„ä»¶ï¼Œæˆ–è€…ä¿®æ”¹å…¶å­å…ƒç´ ï¼Œæ·»åŠ é¢å¤–çš„å…ƒç´ ï¼Œæˆ–è€…åŒ…è£…ä¸€äº›æ ·å¼ã€‚ä¾‹å¦‚ï¼Œåœ¨renderæ–¹æ³•ä¸­è¿”å›super.render()ä¹‹å‰ï¼Œå¯ä»¥æ’å…¥æ–°çš„propsï¼Œæˆ–è€…ä¿®æ”¹childrenã€‚
>
> ä½†è¦æ³¨æ„ï¼ŒReactçš„ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰å½±å“ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨React16åŠä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œå› ä¸ºç”Ÿå‘½å‘¨æœŸæ–¹æ³•æœ‰æ‰€æ”¹å˜ï¼Œæ¯”å¦‚getDerivedStateFromPropsçš„å¼•å…¥ï¼Œå¯èƒ½ä¼šå½±å“åå‘ç»§æ‰¿çš„å®ç°æ–¹å¼ã€‚
>
> æ½œåœ¨çš„é—®é¢˜æœ‰å“ªäº›å‘¢ï¼Ÿæ¯”å¦‚ï¼Œå¦‚æœåŸç»„ä»¶æ˜¯å‡½æ•°å¼ç»„ä»¶ï¼Œåå‘ç»§æ‰¿çš„æ–¹å¼å°±æ— æ³•ä½¿ç”¨ï¼Œå› ä¸ºå‡½æ•°å¼ç»„ä»¶æ²¡æœ‰ç»§æ‰¿çš„å®ä¾‹æ–¹æ³•ã€‚å› æ­¤ï¼Œè¿™ç§HOCåªèƒ½ç”¨äºç±»ç»„ä»¶ã€‚æ­¤å¤–ï¼Œå¦‚æœè¢«åŒ…è£¹çš„ç»„ä»¶ä½¿ç”¨äº†Reactçš„æ–°ç‰¹æ€§ï¼ˆå¦‚Hooksï¼‰ï¼Œå¯èƒ½ä¼šä¸åå‘ç»§æ‰¿çš„æ–¹å¼äº§ç”Ÿå†²çªï¼Œæˆ–è€…éœ€è¦é¢å¤–çš„å¤„ç†ã€‚
>
> æ­¤å¤–ï¼Œéœ€è¦æé†’ç”¨æˆ·è¿™ç§æ¨¡å¼å¯èƒ½å¸¦æ¥çš„ç»´æŠ¤é—®é¢˜ï¼Œæ¯”å¦‚ç ´åç»„ä»¶çš„å°è£…æ€§ï¼Œæˆ–è€…åœ¨Reactæœªæ¥ç‰ˆæœ¬ä¸­å¯èƒ½ä¸æ¨èä½¿ç”¨ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªé—®é¢˜æœ¬èº«æ˜¯æŠ€æœ¯ä¸Šçš„æ¢è®¨ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦ç»™å‡ºå…·ä½“çš„å®ç°æ­¥éª¤å’Œç¤ºä¾‹ä»£ç ã€‚
>
> å¯èƒ½éœ€è¦ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œæ¯”å¦‚å®ç°ä¸€ä¸ªHOCï¼Œåœ¨ç»„ä»¶çš„componentDidMounté‡Œæ·»åŠ æ—¥å¿—ï¼Œæˆ–è€…ä¿®æ”¹å®ƒçš„renderè¾“å‡ºã€‚ç¤ºä¾‹ä»£ç åº”è¯¥å±•ç¤ºå¦‚ä½•ç»§æ‰¿åŸç»„ä»¶ï¼Œè¦†ç›–ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå¹¶è°ƒç”¨åŸæ–¹æ³•ã€‚åŒæ—¶ï¼Œéœ€è¦æ³¨æ„ä¼ é€’propsçš„æ­£ç¡®æ€§ï¼Œä»¥åŠå¤„ç†displayNameä»¥ä¾¿è°ƒè¯•ã€‚
>
> è¿˜æœ‰ï¼Œè¦æŒ‡å‡ºè¿™ç§æ¨¡å¼çš„é€‚ç”¨åœºæ™¯å’Œæ›¿ä»£æ–¹æ¡ˆã€‚æ¯”å¦‚ï¼Œå¦‚æœä¸æ˜¯å¿…é¡»ä¿®æ”¹ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æˆ–renderè¾“å‡ºï¼Œä½¿ç”¨æ™®é€šçš„HOCï¼Œæˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰Hookï¼ˆå¦‚æœæ˜¯å‡½æ•°å¼ç»„ä»¶ï¼‰å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚åå‘ç»§æ‰¿æ¯”è¾ƒé€‚ç”¨äºæ›´åº•å±‚çš„æ‰©å±•éœ€æ±‚ï¼Œä½†éœ€è°¨æ…ä½¿ç”¨ã€‚
>
> æœ€åï¼Œæ€»ç»“å…³é”®æ­¥éª¤ï¼Œè¦†ç›–ç”Ÿå‘½å‘¨æœŸã€ä¿®æ”¹renderæ–¹æ³•ï¼Œå¯èƒ½çš„é£é™©å’Œæ³¨æ„äº‹é¡¹ï¼Œä»¥åŠä»€ä¹ˆæ—¶å€™åº”è¯¥è€ƒè™‘ä½¿ç”¨è¿™ç§é«˜é˜¶æ¨¡å¼ã€‚
>
> 



### æ·±åº¦æŠ€æœ¯å®æ–½æŒ‡å—ï¼šåå‘ç»§æ‰¿æ¨¡å¼ï¼ˆHOC + Render Hijackingï¼‰

#### 1. æ ¸å¿ƒæ‰§è¡Œæœºåˆ¶å›¾è§£

```mermaid
sequenceDiagram
    participant HOC
    participant WrappedComponent
    participant NewComponent
    
    HOC->>+WrappedComponent: ç»§æ‰¿å…³ç³»å»ºç«‹
    WrappedComponent-->>-HOC: æš´éœ²åŸå‹é“¾è®¿é—®
    
    NewComponent->>+HOC: ç”Ÿå‘½å‘¨æœŸé’©å­è§¦å‘
    HOC->>WrappedComponent: æ‹¦æˆªå¹¶å¢å¼ºé’©å­
    WrappedComponent->>+HOC: è¿”å›å¢å¼ºåçš„é€»è¾‘
    HOC-->>-NewComponent: æ¸²æŸ“æ§åˆ¶æƒäº¤è¿˜
```

---

#### 2. ç²¾å¯†ä»£ç å®ç°æ–¹æ¡ˆ

```typescript
type LifecycleHookInterceptor<T extends React.Component> = {
  [K in keyof T]?: T[K] extends (...args: infer A) => infer R 
    ? (originalFn: (...args: A) => R, context: T) => (...args: A) => R 
    : never;
};

function hijackLifecycles<T extends React.ComponentType>(
  WrappedComponent: T,
  interceptors: LifecycleHookInterceptor<InstanceType<T>>
): React.ComponentType {
  return class EnhancedComponent extends (WrappedComponent as any) {
    constructor(props: any) {
      super(props);
      
      Object.entries(interceptors).forEach(([hookName, interceptor]) => {
        const original = (this as any)[hookName];
        if (typeof original === 'function') {
          (this as any)[hookName] = function(...args: any[]) {
            return interceptor(original.bind(this), this)(...args);
          };
        }
      });
    }

    render() {
      const elementsTree = super.render();
      return this.enhanceRenderOutput(elementsTree);
    }

    private enhanceRenderOutput(elementsTree: React.ReactNode): React.ReactNode {
      // æ·±å±‚æ¬¡éå†ä¿®æ”¹è™šæ‹ŸDOM
      const modifyChildren = (node: React.ReactElement): React.ReactElement => {
        if (!React.isValidElement(node)) return node;
        
        const newProps = {
          ...node.props,
          style: { ...node.props.style, border: '1px solid red' }
        };
        
        return React.cloneElement(
          node,
          newProps,
          React.Children.map(node.props.children, child => 
            modifyChildren(child as React.ReactElement)
          )
        );
      };
      
      return modifyChildren(elementsTree as React.ReactElement);
    }
  };
}
```

---

### 3. é«˜é˜¶åº”ç”¨åœºæ™¯åˆ†è§£

#### åœºæ™¯ 1ï¼šé‰´æƒæ§åˆ¶æµ
```typescript
class PrivateComponent extends React.Component {
  componentDidMount() {
    console.log('æ‰§è¡Œæ•æ„Ÿæ“ä½œ');
  }
  
  render() {
    return <div>ç‰¹æƒå†…å®¹</div>;
  }
}

const interceptedAuth = {
  componentDidMount: (original, context) => () => {
    if (!context.props.isAdmin) {
      context.setState({ error: 'æƒé™ä¸è¶³' });
      return;
    }
    original();
  }
};

const ProtectedComponent = hijackLifecycles(PrivateComponent, interceptedAuth);
```

#### åœºæ™¯ 2ï¼šæ€§èƒ½æŒ‡æ ‡ç›‘æ§
```typescript
const withPerfMonitor = (Component) => hijackLifecycles(Component, {
  componentDidUpdate: (original, ctx) => (prevProps, prevState) => {
    performance.mark('updateStart');
    original(prevProps, prevState);
    performance.measure(
      `${ctx.constructor.name}-Update`,
      'updateStart'
    );
  }
});
```

---

### 4. é˜²å¾¡æ€§ç¼–ç¨‹è¦ç‚¹

#### å®‰å…¨æ‹¦æˆªä¹å®«æ ¼

| æ‹¦æˆªç›®æ ‡           | é£é™©ç­‰çº§ | é˜²æŠ¤æªæ–½                           |
|--------------------|----------|------------------------------------|
| render()           | â­â­â­â­   | è™šæ‹ŸDOMå·®åˆ†æ£€æŸ¥é˜²æ­¢æ— æ•ˆé‡æ¸²æŸ“       |
| componentDidMount  | â­â­      | å¼‚å¸¸è¾¹ç•ŒåŒ…è£¹é˜²æ­¢é˜»æ–­åˆå§‹åŒ–æµç¨‹       |
| shouldComponentUpdate | â­â­â­ | Object.isæ¯”è¾ƒæ›¿ä»£å…¨ç­‰åˆ¤æ–­           |
| getDerivedStateFromProps | â­â­â­â­ | çŠ¶æ€å¿«ç…§å›æ»šæœºåˆ¶                 |
| componentDidCatch | â­â­      | å¤šé‡é”™è¯¯å¤„ç†å™¨å¹¶è”                 |

---

#### å…¸å‹é—®é¢˜åº”æ€¥æ–¹æ¡ˆ

```typescript
// æœåŠ¡é™çº§å¤„ç†æœºåˆ¶
const renderFailsafe = (elementsTree: React.ReactNode) => {
  try {
    return enhanceRenderOutput(elementsTree);
  } catch (error) {
    return <div className="error-fallback">
      <h3>Render Error</h3>
      <button onClick={() => location.reload()}>æ¢å¤åŸå§‹è§†å›¾</button>
    </div>;
  }
};

// æ–°ç‰ˆæ›¿ä»£æ–¹æ¡ˆï¼ˆReact 18+ï¼‰
const modernHijack = () => {
  const useLifecycleInterceptor = (componentInstance: any) => {
    useEffect(() => {
      const originalDidMount = componentInstance.componentDidMount;
      componentInstance.componentDidMount = () => {
        console.log('[Interceptor] Before mount');
        originalDidMount?.call(componentInstance);
        console.log('[Interceptor] After mount');
      };

      return () => {
        componentInstance.componentDidMount = originalDidMount;
      };
    }, []);
  };
};
```

---

### 5. æ·±åº¦æ€§èƒ½å½±å“åˆ†æ

```javascript
// é‡æ¸²æŸ“å‹åŠ›æµ‹è¯•
const StressComponent = () => <div>{Math.random()}</div>;
const HijackedComponent = hijackLifecycles(StressComponent, {
  shouldComponentUpdate: (original, ctx) => (nextProps, nextState) => {
    return original(nextProps, nextState) && performance.now() % 2 === 0;
  }
});

// æ€§èƒ½æ£€æµ‹æŒ‡æ ‡
console.profile('Hijacking Overhead');
for (let i = 0; i < 1000; i++) {
  ReactDOM.render(<HijackedComponent />, document.body);
}
console.profileEnd();
```

---

### 6. å·¥ç¨‹åŒ–æœ€ä½³å®è·µ

#### è°ƒè¯•æ ‡å¿—æ³¨å…¥æ–¹æ¡ˆ
```typescript
const enableHijackingDebug = process.env.NODE_ENV === 'development';

const debugLifecycle = (hookName: string) => (
  target: Object,
  propertyKey: string,
  descriptor: TypedPropertyDescriptor<any>
) => {
  const original = descriptor.value!;
  
  descriptor.value = function(...args: any[]) {
    enableHijackingDebug && console.log(
      `[Lifecycle ${hookName}]`, 
      `State:`, this.state,
      `Props:`, this.props
    );
    return original.apply(this, args);
  };
};

// ç±»è£…é¥°å™¨åº”ç”¨
@debugLifecycle('componentDidUpdate')
class ObservedComponent extends React.Component {/* ... */}
```

#### å¯è§†åŒ–ç›‘æ§çŸ©é˜µ
```typescript
const hijackDashboard = (Component, options) => {
  return class extends Component {
    render() {
      return (
        <div className="hijack-container">
          <div className="hijack-indicator">âš ï¸ç›‘æ§ä¸­ | å·²æ‹¦æˆªæ–¹æ³•: {Object.keys(options).join(',')}</div>
          {super.render()}
        </div>
      );
    }
  };
};
```

---

### å…³é”®ç»“è®ºé€‰æ‹©çŸ©é˜µ

```mermaid
gantt
    title æŠ€æœ¯æ–¹æ¡ˆå¯è¡Œæ€§åˆ†æ
    dateFormat  YYYY-MM-DD
    section æŠ€æœ¯é£é™©
    åŸå‹é“¾é‡å†™é£é™© :crit, active, 2023-09-01, 7d
    å¤šç»§æ‰¿å†²çª :crit, 2023-09-08,5d
    Reactç‰ˆæœ¬å…¼å®¹æ€§ :2023-09-10,3d
    
    section æ”¶ç›Šé¢†åŸŸ
    ç»†ç²’åº¦ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ :active, 2023-09-01, 7d
    è·¨ç»„ä»¶AOPèµ‹èƒ½ :2023-09-05, 10d
    æ— ä¾µå…¥å¼å¢å¼º :2023-09-10,5d
```

å»ºè®®åœ¨æ ¸å¿ƒä¸šåŠ¡æ¨¡å—ä¼˜å…ˆå®æ–½ï¼Œé€æ­¥å°†ç›‘æ§/æƒé™/æ—¥å¿—ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹è¿ç§»è‡³è¯¥æ¨¡å¼ï¼Œä½†å¯¹é«˜é¢‘æ›´æ–°ç»„ä»¶ä¿æŒè°¨æ…åº”ç”¨ã€‚
