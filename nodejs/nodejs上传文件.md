> ğŸ’­ å—¯ï¼Œç”¨æˆ·é—®çš„æ˜¯Node.jsæ¥æ”¶æ–‡ä»¶ä¸Šä¼ çš„æµç¨‹ã€‚å‰é¢ä»–å·²ç»æé—®è¿‡å¤§æ–‡ä»¶ä¸Šä¼ ï¼Œæ‰€ä»¥æˆ‘ä¹‹å‰çš„å›å¤å·²ç»å¾ˆè¯¦ç»†äº†ï¼Œç°åœ¨å¯èƒ½æ˜¯æƒ³å…·ä½“ç”¨Node.jsæ¥å®ç°ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘åº”è¯¥å…ˆå›å¿†ä¸€ä¸‹Node.jsä¸­å¤„ç†æ–‡ä»¶ä¸Šä¼ çš„å¸¸è§æ–¹æ³•ï¼Œå°¤å…¶æ˜¯å¤§æ–‡ä»¶çš„æƒ…å†µï¼Œä½†å¯èƒ½è¿™ä¸ªç”¨æˆ·éœ€è¦çš„æ˜¯æ›´åŸºç¡€çš„æµç¨‹ï¼Œç„¶åæ‰©å±•åˆ°å¤§æ–‡ä»¶å¤„ç†ã€‚
>
> é¦–å…ˆï¼Œè¦è€ƒè™‘æ™®é€šçš„è¡¨å•ä¸Šä¼ å’Œåç«¯çš„å¤„ç†è¿‡ç¨‹ã€‚åœ¨Node.jsé‡Œï¼Œé€šå¸¸ä¼šä½¿ç”¨åƒExpressè¿™æ ·çš„æ¡†æ¶æ¥å¤„ç†HTTPè¯·æ±‚ï¼Œè€Œå¤„ç†ä¸Šä¼ çš„æ–‡ä»¶éœ€è¦ä¸­é—´ä»¶ï¼Œæ¯”å¦‚multeræˆ–è€…formidableã€‚è¿™äº›éƒ½æ˜¯å¸¸ç”¨çš„åº“ï¼Œå¯ä»¥å¤„ç†multipart/form-dataç±»å‹çš„è¡¨å•æ•°æ®ã€‚ç”¨æˆ·å¯èƒ½éœ€è¦çŸ¥é“å¦‚ä½•é…ç½®è¿™äº›ä¸­é—´ä»¶ï¼Œæ¥å—æ–‡ä»¶ï¼Œå¹¶ä¿å­˜åˆ°æœåŠ¡å™¨çš„æŸä¸ªç›®å½•ã€‚
>
> æ¥ä¸‹æ¥ï¼Œå¯èƒ½éœ€è¦åˆ†æ­¥éª¤è¯´æ˜æµç¨‹ã€‚ä¾‹å¦‚ï¼Œé¦–å…ˆå®‰è£…å¿…è¦çš„åŒ…ï¼Œæ¯”å¦‚expresså’Œmulterï¼Œç„¶ååˆ›å»ºExpressåº”ç”¨ï¼Œè®¾ç½®ä¸­é—´ä»¶ï¼Œé…ç½®ä¸Šä¼ ç›®å½•ï¼Œå¤„ç†POSTè¯·æ±‚ï¼Œè¿”å›å“åº”ã€‚è¿™æ ·çš„æ­¥éª¤èƒ½å¸®åŠ©ç”¨æˆ·å¿«é€Ÿæ­å»ºä¸€ä¸ªåŸºç¡€çš„æ–‡ä»¶ä¸Šä¼ æ¥å£ã€‚
>
> ä½†åŒæ—¶ï¼Œç”¨æˆ·ä¹‹å‰çš„é—®é¢˜æ¶‰åŠåˆ°å¤§æ–‡ä»¶ä¸Šä¼ ï¼Œæ‰€ä»¥åœ¨å½“å‰çš„é—®é¢˜ä¸‹å¯èƒ½éœ€è¦æåŠåˆ†ç‰‡ä¸Šä¼ çš„å¤„ç†ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚ä½•åœ¨Node.jsä¸­å®ç°åˆ†ç‰‡ä¸Šä¼ çš„é€»è¾‘ã€‚è¿™æ¶‰åŠåˆ°æ¥æ”¶æ–‡ä»¶å—ã€ä¿å­˜ä¸´æ—¶æ–‡ä»¶ã€åˆå¹¶åˆ†ç‰‡ç­‰æ­¥éª¤ã€‚ä¾‹å¦‚ï¼Œæ¯ä¸ªæ–‡ä»¶å—ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ˆæ¯”å¦‚æ–‡ä»¶hashï¼‰ï¼Œåˆ†ç‰‡ç´¢å¼•ï¼Œç”¨æˆ·åœ¨è¯·æ±‚ä¸­å‘é€è¿™äº›ä¿¡æ¯ï¼ŒæœåŠ¡å™¨å°†å®ƒä»¬ä¿å­˜åˆ°ä¸´æ—¶ç›®å½•ï¼Œæœ€ç»ˆåˆå¹¶æ‰€æœ‰åˆ†ç‰‡ã€‚
>
> è¿˜æœ‰éœ€è¦è€ƒè™‘çš„ç‚¹æ˜¯å¦‚ä½•å¤„ç†å¤§æ–‡ä»¶ä¸Šä¼ æ—¶çš„å†…å­˜é—®é¢˜ã€‚ä¼ ç»Ÿçš„ä¸­é—´ä»¶å¦‚multeré»˜è®¤ä½¿ç”¨diskStorageï¼Œä¼šå°†æ–‡ä»¶å†™å…¥ç£ç›˜ï¼Œé¿å…å†…å­˜æº¢å‡ºï¼Œè€Œå¦‚æœæ˜¯ç”¨memoryStorageçš„è¯ï¼Œå¤§æ–‡ä»¶ä¼šå¯¼è‡´å†…å­˜é—®é¢˜ã€‚å› æ­¤éœ€è¦ç¡®ä¿æ­£ç¡®çš„å­˜å‚¨å¼•æ“è¢«é…ç½®ã€‚
>
> åŒæ—¶ï¼Œå¯èƒ½éœ€è¦ç»™å‡ºä»£ç ç¤ºä¾‹ï¼Œè®©ç”¨æˆ·æ›´å®¹æ˜“ç†è§£ã€‚æ¯”å¦‚ï¼Œç”¨multeråˆ›å»ºå®ä¾‹ï¼ŒæŒ‡å®šå­˜å‚¨è·¯å¾„ï¼Œå¤„ç†å•ä¸ªæ–‡ä»¶è¿˜æ˜¯å¤šä¸ªæ–‡ä»¶ï¼Œè®¾ç½®æ–‡ä»¶å¤§å°é™åˆ¶ï¼Œå¤„ç†ä¸Šä¼ å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå°†æ–‡ä»¶ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™å¯èƒ½æ˜¯ä¸€ä¸ªåŸºç¡€çš„ä¸Šä¼ æµç¨‹ï¼Œé€‚ç”¨äºå°æ–‡ä»¶ã€‚
>
> ä½†æ˜¯å¦‚æœç”¨æˆ·éœ€è¦å¤„ç†åˆ†ç‰‡ä¸Šä¼ çš„è¯ï¼Œå¯èƒ½éœ€è¦å±•ç¤ºä¸åŒçš„å¤„ç†æ–¹å¼ã€‚æ¯”å¦‚ï¼Œè‡ªå®šä¹‰è·¯ç”±æ¥å¤„ç†åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡åˆ°è¾¾åä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œæœ€åè§¦å‘åˆå¹¶æ“ä½œã€‚æ­¤æ—¶ï¼Œéœ€è¦ç»´æŠ¤æ¯ä¸ªæ–‡ä»¶çš„åˆ†ç‰‡é¡ºåºï¼Œç¡®è®¤æ‰€æœ‰åˆ†ç‰‡éƒ½ä¸Šä¼ å®Œæˆï¼Œç„¶ååˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ã€‚è¿™æ—¶å€™ï¼Œä»£ç çš„ç»“æ„å¯èƒ½åŒ…æ‹¬æ£€æŸ¥å·²å­˜åœ¨çš„åˆ†ç‰‡ï¼Œç¡®è®¤åˆ†ç‰‡çš„é¡ºåºï¼Œé˜²æ­¢é‡å¤ä¸Šä¼ ç­‰ã€‚
>
> æ­¤å¤–ï¼Œå¯èƒ½è¦æ¶‰åŠåˆ°å¦‚ä½•åˆå¹¶åˆ†ç‰‡æ–‡ä»¶ï¼Œä½¿ç”¨fsæ¨¡å—è¯»å–æ‰€æœ‰åˆ†ç‰‡ï¼ŒæŒ‰é¡ºåºå†™å…¥åˆ°ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œç„¶ååˆ é™¤ä¸´æ—¶åˆ†ç‰‡ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¿…é¡»ç¡®ä¿æ‰€æœ‰çš„åˆ†ç‰‡éƒ½å·²æ­£ç¡®ä¸Šä¼ ï¼Œå¦åˆ™åˆå¹¶åçš„æ–‡ä»¶å¯èƒ½æŸåã€‚
>
> å¦å¤–ï¼Œç”¨æˆ·å¯èƒ½å…³æ³¨å¦‚ä½•å¤„ç†ä¸Šä¼ æ—¶çš„é”™è¯¯ï¼Œæ¯”å¦‚ç½‘ç»œä¸­æ–­å¯¼è‡´çš„ä¼ è¾“å¤±è´¥ï¼Œè¿™æ—¶å€™å¯èƒ½éœ€è¦æ–­ç‚¹ç»­ä¼ çš„æ”¯æŒã€‚æ‰€ä»¥éœ€è¦åç«¯æä¾›ä¸€ä¸ªæ¥å£ï¼Œè®©å‰ç«¯æŸ¥è¯¢æŸä¸ªæ–‡ä»¶çš„ä¸Šä¼ è¿›åº¦ï¼Œå·²ç»ä¸Šä¼ çš„åˆ†ç‰‡ç´¢å¼•ï¼Œè¿™æ ·å‰ç«¯å¯ä»¥ç»§ç»­ä¸Šä¼ å‰©ä¸‹çš„åˆ†ç‰‡ã€‚åœ¨Node.jsä¸­ï¼Œè¿™å¯ä»¥é€šè¿‡ç»´æŠ¤ä¸€ä¸ªæ•°æ®ç»“æ„æˆ–æ•°æ®åº“è¡¨æ¥è®°å½•ä¸Šä¼ çŠ¶æ€ï¼Œæ¯”å¦‚æ¯ä¸ªæ–‡ä»¶çš„åˆ†ç‰‡ä¸Šä¼ æƒ…å†µã€‚
>
> å®‰å…¨æ€§æ–¹é¢ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘æ–‡ä»¶ç±»å‹æ ¡éªŒï¼Œé¿å…ä¸Šä¼ æ¶æ„æ–‡ä»¶ã€‚æ¯”å¦‚ï¼Œåœ¨multerçš„fileFilteré€‰é¡¹ä¸­æ£€æŸ¥æ–‡ä»¶çš„mimetypeæˆ–æ‰©å±•åï¼Œæ‹’ç»ä¸ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œé™åˆ¶ä¸Šä¼ æ–‡ä»¶çš„å¤§å°ï¼Œé¿å…æœåŠ¡å™¨å­˜å‚¨è¢«å æ»¡ã€‚
>
> æ•´ä½“æ¥è¯´ï¼Œå›ç­”åº”è¯¥è¦†ç›–åŸºç¡€çš„æ–‡ä»¶ä¸Šä¼ æµç¨‹ï¼Œä½¿ç”¨multerç­‰ä¸­é—´ä»¶çš„ç¤ºä¾‹ï¼Œå¦‚ä½•å¤„ç†åˆ†ç‰‡ä¸Šä¼ ï¼Œä»¥åŠç›¸å…³çš„æœ€ä½³å®è·µï¼Œå¦‚å†…å­˜ç®¡ç†ã€é”™è¯¯å¤„ç†ã€å®‰å…¨æ€§æªæ–½ç­‰ã€‚å¦å¤–ï¼Œéœ€è¦æ¯”è¾ƒä¸åŒçš„ä¸­é—´ä»¶ï¼Œæ¯”å¦‚multerå’Œformidableçš„é€‚ç”¨åœºæ™¯ï¼Œå¦‚æœæœ‰å¤§æ–‡ä»¶ä¸Šä¼ éœ€æ±‚çš„è¯ï¼Œå¯èƒ½ä¼šæ¨èä½¿ç”¨æ›´çµæ´»æˆ–å¯æ‰©å±•çš„è§£å†³æ–¹æ¡ˆã€‚
>
> å¯èƒ½çš„æ··æ·†ç‚¹åœ¨äºåˆ†ç‰‡ä¸Šä¼ å’Œæ™®é€šä¸Šä¼ çš„å¤„ç†æ–¹å¼ä¸åŒï¼Œè¿™æ—¶å€™è¦æ˜ç¡®åŒºåˆ†ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œåˆ†ç‰‡ä¸Šä¼ éœ€è¦å®¢æˆ·ç«¯å°†æ–‡ä»¶åˆ‡å—ï¼Œè€ŒæœåŠ¡ç«¯éœ€è¦ç›¸åº”çš„æ¥å£æ¥å¤„ç†æ¯ä¸€å—çš„ä¸Šä¼ ï¼Œè€Œæ™®é€šçš„ä¸Šä¼ æ˜¯ä¸€æ¬¡æ€§å°†æ•´ä¸ªæ–‡ä»¶å‘é€åˆ°æœåŠ¡å™¨ã€‚å› æ­¤ï¼ŒNode.jsåç«¯çš„ä¸åŒå¤„ç†æ–¹å¼éœ€è¦è¯¦ç»†è¯´æ˜ã€‚
>
> æ€»ç»“æ€è·¯ï¼šå…ˆä»‹ç»æ™®é€šçš„æ–‡ä»¶ä¸Šä¼ æµç¨‹ï¼Œä½¿ç”¨expresså’Œmulterï¼Œå†æ‰©å±•åˆ°å¤§æ–‡ä»¶çš„åˆ†ç‰‡ä¸Šä¼ å¤„ç†ï¼ŒåŒ…æ‹¬åˆ†ç‰‡çš„ä¿å­˜ã€åˆå¹¶ï¼Œä»¥åŠæ–­ç‚¹ç»­ä¼ çš„æ”¯æŒã€‚åŒæ—¶æŒ‡å‡ºç›¸å…³æ³¨æ„äº‹é¡¹å’Œä¼˜åŒ–ç‚¹ã€‚
>
> 



åœ¨Node.jsä¸­å¤„ç†æ–‡ä»¶ä¸Šä¼ éœ€é€šè¿‡ä¸­é—´ä»¶è§£æHTTPè¯·æ±‚ä¸­çš„æ–‡ä»¶æµï¼Œä»¥ä¸‹æ˜¯æœ€å…¨å®ç°æ–¹æ¡ˆä¸æ“ä½œæµç¨‹ï¼š

---

### **ä¸€ã€æ™®é€šæ–‡ä»¶ä¸Šä¼ ï¼ˆå°æ–‡ä»¶ï¼‰**
ä½¿ç”¨`express + multer`å¿«é€Ÿå®ç°ï¼š

#### **1. åˆå§‹åŒ–é¡¹ç›®ä¸å®‰è£…ä¾èµ–**
```bash
npm install express multer
```

#### **2. åŸºç¡€æœåŠ¡ç«¯ä»£ç **
```javascript
const express = require('express');
const multer = require('multer');
const app = express();

// é…ç½®å­˜å‚¨è§„åˆ™ï¼šå­˜å‚¨åœ¨ç£ç›˜ï¼ˆé¿å…å†…å­˜æº¢å‡ºï¼‰
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/'); // ä¸Šä¼ ç›®å½•
  },
  filename: (req, file, cb) => {
    cb(null, Date.now() + '-' + file.originalname); // å‘½åå”¯ä¸€æ–‡ä»¶
  }
});

// æ–‡ä»¶ç±»å‹è¿‡æ»¤ï¼ˆå®‰å…¨æ€§ï¼‰
const fileFilter = (req, file, cb) => {
  if (file.mimetype === 'image/jpeg' || file.mimetype === 'image/png') {
    cb(null, true); // æ¥å—æ–‡ä»¶
  } else {
    cb(new Error('ä»…æ”¯æŒJPEG/PNGæ–‡ä»¶'), false);
  }
};

// åˆ›å»ºä¸Šä¼ ä¸­é—´ä»¶å®ä¾‹
const upload = multer({
  storage: storage,
  limits: { fileSize: 1024 * 1024 * 50 }, // é™åˆ¶50MB
  fileFilter: fileFilter
});

// å•æ–‡ä»¶ä¸Šä¼ è·¯ç”±
app.post('/upload', upload.single('file'), (req, res) => {
  if (!req.file) return res.status(400).send('æœªä¸Šä¼ æ–‡ä»¶');
  res.json({
    filename: req.file.filename,
    size: req.file.size
  });
});

app.listen(3000, () => console.log('æœåŠ¡å¯åŠ¨: http://localhost:3000'));
```

#### **3. å…³é”®é…ç½®é¡¹è§£æ**
| é…ç½®é¡¹       | ä½œç”¨                                      | ç¤ºä¾‹å€¼                           |
|--------------|-----------------------------------------|-----------------------------------|
| `destination`| æ–‡ä»¶ä¿å­˜ç›®å½•                              | `'uploads/'`                     |
| `filename`   | ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å                            | `Date.now() + '-' + originalname`|
| `fileFilter` | è¿‡æ»¤å±é™©æ–‡ä»¶                              | é™åˆ¶MIMEç±»å‹                     |
| `limits`     | é˜²æ”»å‡»ï¼ˆé™åˆ¶ä¸Šä¼ å¤§å°ç­‰ï¼‰                 | `{ fileSize: 50*1024*1024 }`     |

---

### **äºŒã€å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ï¼ˆæ ¸å¿ƒæµç¨‹ï¼‰**
é’ˆå¯¹GBçº§æ–‡ä»¶éœ€å¼•å…¥åˆ†ç‰‡ä¸Šä¼ ç­–ç•¥ï¼š

#### **1. å®¢æˆ·ç«¯åˆ†ç‰‡ä¸Šä¼ é€»è¾‘**
```javascript
// å‰ç«¯ï¼šå°†æ–‡ä»¶åˆ‡å‰²ä¸ºåˆ†ç‰‡ä¾æ¬¡ä¸Šä¼ 
async function uploadChunk(file, chunkSize = 5 * 1024 * 1024) {
  const totalChunks = Math.ceil(file.size / chunkSize);
  for (let i = 0; i < totalChunks; i++) {
    const chunk = file.slice(i * chunkSize, (i + 1) * chunkSize);
    const formData = new FormData();
    formData.append('chunk', chunk);
    formData.append('chunkIndex', i);
    formData.append('totalChunks', totalChunks);
    formData.append('fileId', file.name + '-' + file.size); // å”¯ä¸€æ ‡è¯†
    
    // å‘é€åˆ†ç‰‡
    await fetch('/upload-chunk', { method: 'POST', body: formData });
  }
}
```

#### **2. Node.jsæ¥æ”¶åˆ†ç‰‡æœåŠ¡ç«¯å®ç°**
é‡‡ç”¨`fs`æ¨¡å—åŠ¨æ€å†™å…¥åˆ†ç‰‡ï¼š

```javascript
const fs = require('fs');
const path = require('path');

// ç›®æ ‡å­˜å‚¨ç›®å½•
const CHUNK_DIR = path.join(__dirname, 'tmp_chunks');

app.post('/upload-chunk', async (req, res) => {
  const { chunkIndex, fileId } = req.body;
  const chunk = req.files.chunk[0]; // å‡è®¾ä½¿ç”¨express-fileupload

  // åˆ›å»ºåˆ†ç‰‡ç›®å½•
  const chunkDir = path.join(CHUNK_DIR, fileId);
  if (!fs.existsSync(chunkDir)) fs.mkdirSync(chunkDir, { recursive: true });
  
  // å†™å…¥åˆ†ç‰‡æ–‡ä»¶ï¼šæ–‡ä»¶åæ ¼å¼ä¸º chunkIndex.raw
  const chunkPath = path.join(chunkDir, `${chunkIndex}`);
  await fs.promises.writeFile(chunkPath, chunk.data);
  
  res.send({ status: 'ok', chunkIndex });
});
```

#### **3. åˆå¹¶åˆ†ç‰‡æ¥å£**
æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆåè§¦å‘åˆå¹¶ï¼š

```javascript
app.post('/merge-chunks', async (req, res) => {
  const { fileId, fileName } = req.body;
  const chunkDir = path.join(CHUNK_DIR, fileId);
  const chunks = fs.readdirSync(chunkDir)
    .sort((a, b) => parseInt(a) - parseInt(b)); // æŒ‰ç´¢å¼•æ’åº
    
  // åˆ›å»ºå¯å†™æµ
  const targetPath = path.join(__dirname, 'uploads', fileName);
  const writeStream = fs.createWriteStream(targetPath);
  
  // é¡ºåºåˆå¹¶æ¯ä¸ªåˆ†ç‰‡
  for (const chunkFile of chunks) {
    const chunkPath = path.join(chunkDir, chunkFile);
    const buffer = fs.readFileSync(chunkPath);
    writeStream.write(buffer);
    fs.unlinkSync(chunkPath); // åˆ é™¤åˆ†ç‰‡
  }
  writeStream.end();
  
  // æ¸…ç†ç›®å½•
  fs.rmdirSync(chunkDir);
  
  res.send({ status: 'merged', path: targetPath });
});
```

---

### **ä¸‰ã€æ–­ç‚¹ç»­ä¼ å®ç°**
è®°å½•å·²ä¸Šä¼ åˆ†ç‰‡ï¼Œåç»­ä¸Šä¼ è·³è¿‡ï¼š

#### **1. æ–°å¢åˆ†ç‰‡çŠ¶æ€æ£€æŸ¥æ¥å£**
```javascript
app.get('/check-chunks', async (req, res) => {
  const { fileId } = req.query;
  const chunkDir = path.join(CHUNK_DIR, fileId);
  
  if (!fs.existsSync(chunkDir)) {
    return res.send({ exists: false, uploadedChunks: [] });
  }
  
  const uploadedChunks = fs.readdirSync(chunkDir)
    .map(name => parseInt(name));
  res.send({ exists: false, uploadedChunks });
});
```

#### **2. å®¢æˆ·ç«¯ä¼˜åŒ–ä¸Šä¼ é€»è¾‘**
```javascript
async function uploadFile(file) {
  const { exists, uploadedChunks } = await checkChunks();
  if (exists) return; // å®Œæ•´æ–‡ä»¶å·²å­˜åœ¨
  
  for (let i = 0; i < totalChunks; i++) {
    if (uploadedChunks.includes(i)) continue; // è·³è¿‡å·²ä¼ åˆ†ç‰‡
    await uploadChunk(file, i);
  }
  await mergeChunks();
}
```

---

### **å››ã€ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–ç­–ç•¥**

#### **1. å®‰å…¨é˜²æŠ¤**
```javascript
// a. é™åˆ¶ä¸Šä¼ é¢‘ç‡
const rateLimit = require('express-rate-limit');
app.use('/upload-chunk', rateLimit({
  windowMs: 60 * 1000,
  max: 100 // æ¯åˆ†é’Ÿ100æ¬¡ä¸Šä¼ åˆ†ç‰‡è¯·æ±‚
}));

// b. ç—…æ¯’æ‰«æï¼ˆè°ƒç”¨ClamAVç­‰ï¼‰
const clamav = require('clamav.js');
app.post('/upload', upload.single('file'), async (req, res) => {
  const result = await clamav.scanFile(req.file.path);
  if (result.hasVirus) {
    fs.unlinkSync(req.file.path);
    return res.status(400).send('æ–‡ä»¶åŒ…å«ç—…æ¯’');
  }
});
```

#### **2. å¤šæœåŠ¡å™¨éƒ¨ç½²æ–¹æ¡ˆ**
è‹¥éƒ¨ç½²å¤šå°NodeæœåŠ¡å™¨ï¼š
- **æ–¹æ¡ˆAï¼šç»Ÿä¸€å…±äº«å­˜å‚¨**  
  åˆ†ç‰‡ä¸Šä¼ è‡³NAS/S3/MinIOï¼Œæ‰€æœ‰èŠ‚ç‚¹å‡å¯è®¿é—®åˆå¹¶ã€‚
  
- **æ–¹æ¡ˆBï¼šé»æ€§ä¼šè¯ï¼ˆSticky Sessionï¼‰**  
  é€šè¿‡Nginxçš„`ip_hash`æˆ–ç”¨æˆ·IDç»‘å®šåŒä¸€æœåŠ¡å™¨å¤„ç†ç›¸åŒæ–‡ä»¶çš„åˆ†ç‰‡ã€‚

---

### **äº”ã€æ€§èƒ½å¯¹æ¯”ï¼šå†…å­˜å­˜å‚¨ vs. ç£ç›˜å­˜å‚¨**

| å­˜å‚¨æ–¹å¼ | ä¼˜ç‚¹              | ç¼ºç‚¹                  | é€‚ç”¨åœºæ™¯         |
|----------|------------------|----------------------|------------------|
| Memory   | é€Ÿåº¦å¿«           | å¤§æ–‡ä»¶ä¼šå¯¼è‡´å†…å­˜æº¢å‡º  | <100MBå°æ–‡ä»¶      |
| Disk     | æ— å†…å­˜å‹åŠ›       | é€Ÿåº¦ç¨æ…¢             | ä»»ä½•å¤§å°æ–‡ä»¶     |

**å»ºè®®ï¼š** å§‹ç»ˆä½¿ç”¨ç£ç›˜å­˜å‚¨é¿å…å†…å­˜æ³„æ¼é£é™©ã€‚

---

### **ä»£ç ç¤ºä¾‹ï¼šæµè§ˆå™¨å®¢æˆ·ç«¯**

```html
<input type="file" id="fileInput" />
<button onclick="upload()">ä¸Šä¼ </button>

<script>
async function upload() {
  const file = document.getElementById('fileInput').files[0];
  
  // 1. è·å–å·²ä¸Šä¼ åˆ†ç‰‡
  const checkResponse = await fetch(`/check-chunks?fileId=${file.name}`);
  const { uploadedChunks } = await checkResponse.json();

  // 2. åˆ†ç‰‡ä¸Šä¼ 
  const chunkSize = 5 * 1024 * 1024;
  for (let i = 0; i < Math.ceil(file.size / chunkSize); i++) {
    if (uploadedChunks.includes(i)) continue; // æ–­ç‚¹ç»­ä¼ é€»è¾‘
    
    const chunk = file.slice(i * chunkSize, (i + 1) * chunkSize);
    const formData = new FormData();
    formData.append('chunk', chunk);
    formData.append('chunkIndex', i);
    formData.append('fileId', file.name);
    
    await fetch('/upload-chunk', { method: 'POST', body: formData });
  }

  // 3. åˆå¹¶è¯·æ±‚
  await fetch('/merge-chunks', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ fileId: file.name, fileName: file.name })
  });
}
</script>
```

---

### **å…­ã€å¤šæ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆ             | å®ç°å¤æ‚åº¦ | æ”¯æŒæ–‡ä»¶å¤§å° | å¯é æ€§ | é€‚ç”¨åœºæ™¯               |
|------------------|------------|--------------|--------|------------------------|
| æ™®é€šè¡¨å•ä¸Šä¼      | â˜…â˜†â˜†        | <200MB       | ä½     | ç®€å•åº”ç”¨               |
| åˆ†ç‰‡ä¸Šä¼          | â˜…â˜…â˜†        | æ— é™åˆ¶       | é«˜     | ä¼ä¸šçº§å¤§æ–‡ä»¶ä¸Šä¼        |
| ç¬¬ä¸‰æ–¹äº‘å­˜å‚¨ç›´ä¼  | â˜…â˜…â˜…        | æ— é™åˆ¶       | æé«˜   | é«˜å¹¶å‘ç”Ÿäº§ç¯å¢ƒ         |

---

**æ€»ç»“**ï¼š  
Node.jsé€šè¿‡åˆç†é€‰æ‹©ä¸­é—´ä»¶ï¼ˆmulter/formidableï¼‰å’Œåˆ†ç‰‡å¤„ç†é€»è¾‘ï¼Œå¯ç¨³å®šæ¥æ”¶TBçº§æ–‡ä»¶ã€‚å…³é”®ç‚¹åœ¨äºï¼š
1. **åˆ†ç‰‡å­˜å‚¨ç­–ç•¥**ï¼šä½¿ç”¨ç£ç›˜å­˜å‚¨åˆ†ç‰‡ã€‚
2. **åˆå¹¶åŸå­æ€§**ï¼šç¡®ä¿æ‰€æœ‰åˆ†ç‰‡æ­£ç¡®åˆå¹¶ã€‚
3. **èµ„æºæ¸…ç†**ï¼šåŠæ—¶åˆ é™¤ä¸´æ—¶åˆ†ç‰‡é¿å…ç£ç›˜å æ»¡ã€‚
4. **å®‰å…¨é˜²æŠ¤**ï¼šç—…æ¯’æ‰«æ+æ–‡ä»¶ç±»å‹ç™½åå•ã€‚
