> ğŸ’­ å¥½çš„ï¼Œç”¨æˆ·ç°åœ¨é—®åˆ°çš„æ˜¯CommonJSå’ŒES Modulesçš„å·®å¼‚åŠå…¼å®¹æ€§å¤„ç†ã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥ä»å‡ ä¸ªæ–¹é¢å…¥æ‰‹ï¼Œé¦–å…ˆåˆ†æç”¨æˆ·çš„èƒŒæ™¯ï¼Œå¯èƒ½çš„èº«ä»½ï¼Œç„¶åæ‰¾å‡ºä»–ä»¬å¯èƒ½å­˜åœ¨çš„ç–‘æƒ‘ç‚¹ã€‚
>
> ç”¨æˆ·çš„èº«ä»½å¯èƒ½æ˜¯å‰ç«¯æˆ–Node.jså¼€å‘è€…ï¼Œå¯èƒ½åœ¨å­¦ä¹ æ¨¡å—ç³»ç»Ÿæ—¶é‡åˆ°çš„å›°æƒ‘ã€‚ä»–ä»¬å¯èƒ½åœ¨é¡¹ç›®ä¸­é‡åˆ°æ··åˆä½¿ç”¨ä¸¤ç§æ¨¡å—çš„æƒ…å†µï¼Œå¯¼è‡´å…¼å®¹æ€§é—®é¢˜ï¼Œæˆ–è€…æƒ³æ›´æ·±å…¥äº†è§£ä¸¤è€…å·®å¼‚ä»¥ä¾¿æ›´å¥½åœ°è®¾è®¡ä»£ç ç»“æ„ã€‚
>
> é¦–å…ˆç”¨æˆ·éœ€è¦çŸ¥é“ä¸¤è€…çš„åŸºæœ¬åŒºåˆ«ï¼Œæ¯”å¦‚è¯­æ³•ä¸åŒï¼ŒCommonJSä½¿ç”¨requireå’Œmodule.exportsï¼Œè€ŒESMä½¿ç”¨import/exportã€‚ç„¶åéœ€è¦æ¯”è¾ƒå®ƒä»¬çš„åŠ è½½æœºåˆ¶ï¼šCommonJSæ˜¯åŠ¨æ€åŠ è½½ï¼Œè¿è¡Œæ—¶æ‰§è¡Œï¼›ESMæ˜¯é™æ€ï¼Œé¢„å¤„ç†é˜¶æ®µè§£æã€‚è¿™å¯¼è‡´è¯¸å¦‚Tree Shakingåªèƒ½åœ¨ESMä¸­æœ‰æ•ˆï¼Œè€ŒCommonJSæ›´çµæ´»ä½†éš¾ä»¥ä¼˜åŒ–ã€‚
>
> æ¥ç€ç”¨æˆ·å¯èƒ½éœ€è¦äº†è§£ä¸ºä»€ä¹ˆNode.jsç°åœ¨æ”¯æŒESMï¼Œä»¥åŠä¸¤ç§æ¨¡å—åœ¨Node.jsä¸­çš„å…¼å®¹æ€§é—®é¢˜ã€‚æ¯”å¦‚æ–‡ä»¶æ‰©å±•åï¼ˆ.mjs vs .cjsï¼‰ï¼Œpackage.jsonä¸­çš„typeå­—æ®µï¼Œå¦‚ä½•ç›¸äº’å¼•ç”¨ï¼Œä»¥åŠåœ¨ESMä¸­å¦‚ä½•åŠ è½½CommonJSæ¨¡å—ï¼Œåä¹‹æ˜¯å¦å¯è¡Œç­‰ã€‚
>
> æ­¤å¤–ï¼Œç”¨æˆ·å¯èƒ½æƒ³çŸ¥é“å®é™…åº”ç”¨ä¸­çš„å…¼å®¹æ€§å¤„ç†ç­–ç•¥ï¼Œæ¯”å¦‚ä½¿ç”¨Babelè½¬æ¢ï¼Œæˆ–åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é…ç½®typeå­—æ®µï¼Œä»¥åŠä¸¤ç§æ¨¡å—ä¹‹é—´äº’æ“ä½œæ—¶çš„æ³¨æ„äº‹é¡¹ï¼Œå¦‚é»˜è®¤å¯¼å‡ºå’Œå‘½åå¯¼å‡ºçš„åŒºåˆ«ã€‚
>
> è¿˜åº”è¯¥æåˆ°å¾ªç¯ä¾èµ–çš„å¤„ç†å·®å¼‚ï¼Œå› ä¸ºåœ¨CommonJSä¸­ç”±äºåŠ¨æ€åŠ è½½ï¼Œå¤„ç†æ–¹å¼ä¸ESMçš„é™æ€è§£æä¸åŒï¼Œå¯èƒ½å¯¼è‡´ä¸åŒçš„è¡Œä¸ºã€‚è¿™æ˜¯å¼€å‘ä¸­éœ€è¦ç‰¹åˆ«æ³¨æ„çš„åœ°æ–¹ã€‚
>
> æœ€åï¼Œç”¨æˆ·å¯èƒ½å…³å¿ƒæœªæ¥çš„å‘å±•è¶‹åŠ¿ï¼ŒESMæ˜¯å¦ä¼šå…¨é¢å–ä»£CommonJSï¼Œä½†ä¹Ÿè¦æŒ‡å‡ºåœ¨Node.jsç”Ÿæ€ä¸­CommonJSä»æœ‰å¤§é‡é—ç•™ä»£ç ï¼ŒçŸ­æœŸå†…éœ€è¦å…¼å®¹å¤„ç†ã€‚
>
> éœ€è¦é¿å…è¿‡äºæŠ€æœ¯æœ¯è¯­ï¼Œç”¨ç®€æ´çš„å¯¹æ¯”å’Œç¤ºä¾‹è¯´æ˜é—®é¢˜ï¼Œç¡®ä¿ç”¨æˆ·ç†è§£å…³é”®ç‚¹ã€‚æ­¤å¤–ï¼Œæ³¨æ„æœ‰æ²¡æœ‰å¸¸è§çš„è¯¯åŒºï¼Œæ¯”å¦‚åœ¨ESMä¸­ä½¿ç”¨requireä¼šå¯¼è‡´é”™è¯¯ï¼Œè€Œéœ€è¦è¿›è¡Œå°è£…æˆ–è½¬æ¢ã€‚å¯èƒ½è¿˜éœ€è¦è§£é‡Šä¸ºä»€ä¹ˆESMéœ€è¦é¡¶å±‚å¯¼å…¥ï¼Œä¸èƒ½åŠ¨æ€å¯¼å…¥ï¼ˆä½†å…¶å®ESMæœ‰åŠ¨æ€import()å‡½æ•°ï¼‰ã€‚
>
> æ€»ç»“æ—¶ï¼Œç»™å‡ºä½¿ç”¨å»ºè®®ï¼Œå¸®åŠ©ç”¨æˆ·æ ¹æ®é¡¹ç›®éœ€æ±‚é€‰æ‹©æ¨¡å—ç³»ç»Ÿï¼Œæˆ–è€…åˆ¶å®šè¿ç§»ç­–ç•¥ã€‚åŒæ—¶å¼ºè°ƒå…¼å®¹æ€§å¤„ç†çš„æ–¹æ³•ï¼Œæ¯”å¦‚é€šè¿‡å·¥å…·é“¾æˆ–é…ç½®æ–‡ä»¶çš„è°ƒæ•´ï¼Œç¡®ä¿ä¸¤ç§æ¨¡å—å¯ä»¥å’Œå¹³å…±å­˜ã€‚
>
> 



Node.js çš„æ¨¡å—åŠ è½½æœºåˆ¶å­˜åœ¨ **CommonJSï¼ˆCJSï¼‰** å’Œ **ES Modulesï¼ˆESMï¼‰** ä¸¤å¥—æ ‡å‡†ï¼ŒäºŒè€…çš„å®ç°åŸç†å’Œå…¼å®¹æ€§å¤„ç†å·®å¼‚æ˜¾è‘—ï¼š
å¯ç›´æ¥å¯¹æ¯”äºŒè€…çš„æ ¸å¿ƒå·®å¼‚ï¼Œå¹¶é€šè¿‡åœºæ™¯åŒ–ç¤ºä¾‹è¯´æ˜å…¼å®¹æ€§é—®é¢˜ã€‚

---

### **ä¸€ã€åŸºç¡€å·®å¼‚å¯¹æ¯”**
|              | **CommonJSï¼ˆCJSï¼‰**             | **ES Modulesï¼ˆESMï¼‰**           |
|--------------|----------------------------------|----------------------------------|
| **å…³é”®è¯**   | `require()`, `module.exports`   | `import`, `export`               |
| **åŠ è½½æ–¹å¼** | **åŠ¨æ€åŠ è½½**ï¼ˆæ‰§è¡Œæ—¶åˆ†æä¾èµ–ï¼‰   | **é™æ€è§£æ**ï¼ˆé¢„å¤„ç†é˜¶æ®µæ„å»ºä¾èµ–æ ‘ï¼‰ |
| **è¿è¡Œç¯å¢ƒ** | çº¯ Node.js åŸç”Ÿæ”¯æŒ              | éœ€è¦ `.mjs` åç¼€æˆ– `package.json` é…ç½® |
| **åŒæ­¥æ€§**   | åŒæ­¥åŠ è½½æ¨¡å—                     | å¤©ç”Ÿæ”¯æŒå¼‚æ­¥åŠ è½½ï¼ˆ`import()`ï¼‰   |
| **è¡Œä¸ºç‰¹ç‚¹** | å…è®¸æ¡ä»¶å¯¼å…¥ï¼ˆ`if` åˆ†æ”¯åŠ¨æ€åŠ è½½ï¼‰| é¡¶å±‚å¯¼å…¥ä¸å¯åŠ¨æ€æ‹†åˆ†ï¼ˆéœ€ç”¨ `import()`ï¼‰ |
| **ç¼“å­˜æœºåˆ¶** | æ¨¡å—å®ä¾‹åŒ–ç»“æœç¼“å­˜               | å¼•ç”¨ç»‘å®šï¼ˆå®æ—¶åæ˜ å¯¼å‡ºå€¼çš„å˜åŒ–ï¼‰ |

---

### **äºŒã€æ ¸å¿ƒå·®å¼‚è¯¦è§£**
#### 1. **æ¨¡å—è§£æé€»è¾‘**
- **CJS**ï¼š  
  ```js
  // è¿è¡Œæ—¶åŠ¨æ€è§£æï¼ˆè·¯å¾„å¯æ‹¼æ¥ï¼‰
  const utils = require(`./${path}.js`);
  ```
  ä»£ç  **æ‰§è¡Œé˜¶æ®µ** è§£æä¾èµ–ï¼Œ`require()` å¯å‡ºç°åœ¨ä»»ä½•ä½ç½®ï¼ˆå¦‚å‡½æ•°å†…éƒ¨ï¼‰ã€‚

- **ESM**ï¼š  
  ```js
  // é™æ€è§£æï¼ˆè·¯å¾„å¿…é¡»ç¡¬ç¼–ç ï¼‰
  import utils from './utils.js';
  ```
  æ¨¡å—ä¾èµ–åœ¨ **é¢„å¤„ç†é˜¶æ®µ** åˆ†æå®Œæˆï¼Œ`import` å¿…é¡»å£°æ˜åœ¨é¡¶å±‚ï¼ˆåŠ¨æ€å¯¼å…¥éœ€ç”¨ `import()`ï¼‰ã€‚

---

#### 2. **æ¨¡å—å¯¼å‡ºè¡Œä¸º**
- **CJS** æ˜¯ **å€¼æ‹·è´**ï¼ˆåŸå§‹ç±»å‹ç›´æ¥å¤åˆ¶ï¼Œå¯¹è±¡ç±»å‹æµ…æ‹·è´ï¼‰ï¼š
  ```js
  // counter.js
  let count = 0;
  module.exports = { count };
  
  // main.js
  const { count } = require('./counter');
  count++; // ä¸ä¼šå½±å“åŸæ¨¡å—çš„ count å€¼
  ```

- **ESM** æ˜¯ **å®æ—¶å¼•ç”¨ç»‘å®š**ï¼ˆç±»ä¼¼æŒ‡é’ˆï¼‰ï¼š
  ```js
  // counter.mjs
  export let count = 0;

  // main.mjs
  import { count } from './counter.mjs';
  count++; // ä¼šä¿®æ”¹åŸæ¨¡å—çš„ count å€¼
  ```

---

#### 3. **å¾ªç¯ä¾èµ–å¤„ç†**
- **CJS çš„æ¾æ•£æ€§**ï¼ˆå¯èƒ½äº§ç”Ÿä¸­é—´çŠ¶æ€ï¼‰ï¼š  
  å½“ä¸¤ä¸ªæ¨¡å—äº’ä¸ºä¾èµ–æ—¶ï¼ŒCJS å…è®¸æœªå®Œå…¨åˆå§‹åŒ–çš„å¼•ç”¨ï¼ˆå…ˆå¼•ç”¨ç©ºå¯¹è±¡ï¼Œåå¡«å……å†…å®¹ï¼‰ã€‚

- **ESM çš„ä¸¥æ ¼æ€§**ï¼š  
  ESM çš„å¼•ç”¨æŒ‡å‘æ¨¡å—çš„åŸå§‹å †å†…å­˜ï¼Œå³ä½¿æ¨¡å—æœªåˆå§‹åŒ–å®Œæˆï¼Œä¼šæŠ›å‡ºæš‚æ—¶æ€§æ­»åŒºé”™è¯¯ã€‚

---

### **ä¸‰ã€Node.js ä¸­çš„å…¼å®¹æ€§å¤„ç†**
Node.js ä» v13.2.0 å¼€å§‹æ­£å¼æ”¯æŒ ESMï¼Œä½†éœ€è¦é…ç½®ï¼š

#### 1. **æ–‡ä»¶ç±»å‹æ ‡è¯†**
| æ–¹æ³•                   | è¯´æ˜                                |
|------------------------|-------------------------------------|
| æ–‡ä»¶æ‰©å±•å `.mjs`      | å¼ºåˆ¶è§†ä¸º ESM æ¨¡å—                   |
| æ–‡ä»¶æ‰©å±•å `.cjs`      | å¼ºåˆ¶è§†ä¸º CJS æ¨¡å—                   |
| `package.json` é…ç½®     | è®¾ç½® `"type": "module"`  è¡¨ç¤ºä½¿ç”¨ ESM |

---

#### 2. **è·¨æ¨¡å—äº’æ“ä½œ**
| **æ“ä½œæ–¹å‘**            | **å®ç°æ–¹å¼**                        | **æ³¨æ„äº‹é¡¹**                                      |
|-------------------------|-------------------------------------|-------------------------------------------------|
| **ESM â†’ å¼•å…¥ CJS**      | ä½¿ç”¨ `import` è¯­æ³•                 | CJS çš„ `module.exports` ä¼šè¢«è½¬æˆ ESM çš„ `default` å¯¼å‡º |
| **CJS â†’ å¼•å…¥ ESM**      | ç”¨ `await import()` åŠ¨æ€åŠ è½½       | å¿…é¡»å¼‚æ­¥æ“ä½œï¼Œä¸”éœ€ç”¨ `default` è®¿é—®å¯¼å‡º          |

##### ç¤ºä¾‹ï¼šCJS ä¸­åŠ è½½ ESM
```js
// CJS æ–‡ä»¶ï¼ˆcommon.jsï¼‰
(async () => {
  const esModule = await import('./esm-module.mjs');
  console.log(esModule.default); // ESM çš„é»˜è®¤å¯¼å‡º
})();
```

##### ç¤ºä¾‹ï¼šESM ä¸­åŠ è½½ CJS
```js
// ESM æ–‡ä»¶ï¼ˆesm.mjsï¼‰
import cjsModule from './common.cjs'; // CJS å¯¼å‡ºè¢«åŒ…è£…æˆ default
console.log(cjsModule);
```

---

### **å››ã€å…¼å®¹æ€§å®æˆ˜åœºæ™¯**
#### åœºæ™¯ 1ï¼šESM ä½¿ç”¨ `__dirname`
ESM ä¸­ä¸å­˜åœ¨ CJS çš„å…¨å±€å˜é‡ `__dirname`ï¼Œéœ€é€šè¿‡ `url` æ¨¡å—è½¬æ¢ï¼š
```javascript
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __dirname = dirname(fileURLToPath(import.meta.url));
```

#### åœºæ™¯ 2ï¼šç»Ÿä¸€æ¨¡å—å…¥å£
åœ¨æ··åˆé¡¹ç›®ä¸­ï¼Œé€šè¿‡ `package.json` æŒ‡å®šåŒå…¥å£ï¼š
```json
{
  "exports": {
    "require": "./index.cjs",  // CJS å…¥å£
    "import": "./index.mjs"    // ESM å…¥å£
  }
}
```

---

### **äº”ã€å·¥å…·é“¾æ”¯æŒ**
#### 1. Babel è½¬æ¢
é€šè¿‡ `@babel/preset-env` æˆ– `@babel/plugin-transform-modules-commonjs` å°† ESM è½¬æ¢ä¸º CJSï¼š
```javascript
// ESM åŸä»£ç 
export const name = 'Alice';

// Babel è½¬æ¢åï¼ˆCJS æ ¼å¼ï¼‰
exports.name = 'Alice';
```

#### 2. TypeScript é…ç½®
åœ¨ `tsconfig.json` ä¸­è®¾ç½®æ¨¡å—è¾“å‡ºæ ¼å¼ï¼š
```json
{
  "compilerOptions": {
    "module": "commonjs" // æˆ– "es2022"
  }
}
```

---

### **æ€»ç»“**
| **é€‰æ‹©æ ‡å‡†**        | **æ¨èåœºæ™¯**                         |
|--------------------|-------------------------------------|
| **ä¼˜å…ˆä½¿ç”¨ ESM**   | æ–°é¡¹ç›®ã€æµè§ˆå™¨ç¯å¢ƒã€éœ€è¦ Tree Shaking ä¼˜åŒ– |
| **é™çº§åˆ° CJS**     | æ—§é¡¹ç›®ç»´æŠ¤ã€éœ€è¦åŠ¨æ€åŠ è½½ã€ä¾èµ–æœªé€‚é… ESM çš„åº“ | 

**å…¼å®¹æ ¸å¿ƒåŸåˆ™**ï¼š  
- ESM æ˜¯æœªæ¥æ ‡å‡†ï¼ŒNode.js ç”Ÿæ€æ­£å‘å…¶è¿‡æ¸¡  
- æ··ç”¨ä¸¤ç§æ¨¡å—æ—¶ï¼ŒåŠ¡å¿…æ˜¾å¼å£°æ˜æ–‡ä»¶åç¼€ï¼ˆ`.mjs`/`.cjs`ï¼‰å’Œ `package.json` çš„ `type` å­—æ®µ
