> ğŸ’­ å—¯ï¼Œç”¨æˆ·é—®äº†Node.jsä¸­çš„unhandledRejectionäº‹ä»¶å’Œæµè§ˆå™¨ç¯å¢ƒçš„å·®å¼‚ã€‚è¿™ä¸ªé—®é¢˜çœ‹èµ·æ¥æœ‰ç‚¹æŠ€æœ¯æ€§ï¼Œä½†æˆ‘è§‰å¾—æˆ‘éœ€è¦å…ˆç†è§£åŸºæœ¬æ¦‚å¿µï¼Œå†æ¯”è¾ƒä¸¤è€…çš„ä¸åŒç‚¹ã€‚
>
> é¦–å…ˆï¼Œæˆ‘çŸ¥é“åœ¨JavaScriptä¸­ï¼ŒPromiseè¢«æ‹’ç»ï¼ˆrejectedï¼‰æ—¶å¦‚æœæ²¡æœ‰å¯¹åº”çš„.catchå¤„ç†ï¼Œå°±ä¼šè§¦å‘unhandledRejectionäº‹ä»¶ã€‚ä½†Node.jså’Œæµè§ˆå™¨çš„å¤„ç†æ–¹å¼å¯èƒ½ä¸ä¸€æ ·ã€‚æˆ‘åº”è¯¥å›å¿†ä¸€ä¸‹ä¸¤è€…å„è‡ªçš„è¡Œä¸ºã€‚
>
> Node.jsçš„unhandledRejectionäº‹ä»¶ï¼Œæˆ‘è®°å¾—å¯ä»¥é€šè¿‡process.onæ¥ç›‘å¬ã€‚ä½†ç”¨æˆ·æåˆ°çš„å·®å¼‚ï¼Œå¯èƒ½åŒ…æ‹¬ç›‘å¬çš„APIã€é»˜è®¤è¡Œä¸ºã€ä»¥åŠåç»­ç‰ˆæœ¬çš„å˜åŒ–ã€‚æ¯”å¦‚ï¼Œå¬è¯´Node.jsä»¥å‰ä¼šç›´æ¥æŠ›å‡ºé”™è¯¯å¹¶å¯¼è‡´è¿›ç¨‹é€€å‡ºï¼Œè€Œåæ¥æ”¹æˆäº†è­¦å‘Šï¼Œå¯èƒ½é»˜è®¤ä¸ä¼šç»ˆæ­¢è¿›ç¨‹ï¼Ÿ
>
> åœ¨æµè§ˆå™¨ä¸­ï¼Œå¯èƒ½æ˜¯åœ¨windowå¯¹è±¡ä¸Šç›‘å¬unhandledrejectionäº‹ä»¶ï¼Œå¯¹å—ï¼Ÿè€Œä¸”æµè§ˆå™¨å¯èƒ½åªæ˜¯è®°å½•é”™è¯¯ï¼Œä½†ä¸ä¼šå½±å“é¡µé¢ç»§ç»­è¿è¡Œã€‚æ­¤å¤–ï¼Œå¯èƒ½ä¸¤è€…çš„å‚æ•°ä¼ é€’æ–¹å¼ä¸åŒï¼Œæ¯”å¦‚äº‹ä»¶å¯¹è±¡çš„ç»“æ„ä¸ä¸€æ ·ã€‚ä¾‹å¦‚ï¼Œæµè§ˆå™¨çš„äº‹ä»¶å¯¹è±¡æœ‰promiseå’Œreasonå±æ€§ï¼Œè€ŒNode.jsçš„äº‹ä»¶å¤„ç†å‡½æ•°æ¥æ”¶çš„æ˜¯reasonå’Œpromiseä¸¤ä¸ªå‚æ•°ã€‚
>
> å¯¹äº†ï¼Œè¿˜æœ‰rejectionHandledçš„æƒ…å†µã€‚å¦‚æœç¨åæ·»åŠ äº†catchå¤„ç†ï¼Œæ˜¯å¦ä¼šè§¦å‘å¦ä¸€ä¸ªäº‹ä»¶ï¼Ÿåœ¨Node.jsä¸­æœ‰æ²¡æœ‰å¯¹åº”çš„äº‹ä»¶ï¼Ÿæ¯”å¦‚unhandledRejectionå’ŒrejectionHandledï¼Œè€Œæµè§ˆå™¨å¯èƒ½ä¹Ÿæœ‰ç±»ä¼¼çš„å¤„ç†æœºåˆ¶ï¼Œä½†å…·ä½“å®ç°å¯èƒ½æœ‰å·®å¼‚ã€‚
>
> å¦å¤–ï¼Œç”¨æˆ·å¯èƒ½æƒ³çŸ¥é“åœ¨å®é™…å¼€å‘ä¸­éœ€è¦æ³¨æ„ä»€ä¹ˆã€‚æ¯”å¦‚ï¼Œåœ¨Node.jsä¸­å¦‚æœæ²¡æœ‰å¤„ç†Promiseçš„rejectionï¼Œå¯èƒ½ä¼šå¯¼è‡´è¿›ç¨‹å´©æºƒï¼Œå°¤å…¶æ˜¯æ—§ç‰ˆæœ¬ï¼Œä½†æ–°ç‰ˆæœ¬å¯èƒ½åªæ˜¯è­¦å‘Šã€‚è€Œæµè§ˆå™¨ä¸­å¯èƒ½åªæ˜¯åœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ï¼Œä½†åº”ç”¨å¯ä»¥ç»§ç»­è¿è¡Œã€‚è¿™å¯èƒ½å½±å“åº”ç”¨ç¨‹åºçš„å¥å£®æ€§å’Œé”™è¯¯å¤„ç†ç­–ç•¥ã€‚
>
> è¿˜æœ‰ï¼Œæ˜¯å¦éœ€è¦è®¨è®ºNode.jså’Œæµè§ˆå™¨åœ¨äº‹ä»¶å¾ªç¯ä¸Šçš„å·®å¼‚å¯¼è‡´çš„unhandledRejectionè§¦å‘æ—¶æœºçš„ä¸åŒï¼Ÿæ¯”å¦‚ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—çš„å¤„ç†æ–¹å¼æ˜¯å¦å½±å“è¿™ä¸¤ä¸ªç¯å¢ƒä¸­äº‹ä»¶çš„è§¦å‘æ—¶é—´ï¼Ÿ
>
> ç°åœ¨è¦ç»„ç»‡è¿™äº›æ€è·¯ï¼Œåˆ†æˆå‡ ç‚¹å¯¹æ¯”ï¼Œç„¶åä¸¾ä¾‹è¯´æ˜ï¼Œç¡®ä¿è¦†ç›–ä¸»è¦å·®å¼‚ç‚¹ã€‚åŒæ—¶è¦ç¡®ä¿ä¿¡æ¯çš„å‡†ç¡®æ€§ï¼Œå¯èƒ½éœ€è¦æŸ¥é˜…æœ€æ–°çš„æ–‡æ¡£ç¡®è®¤ã€‚
>
> æ¯”å¦‚ï¼Œåœ¨Node.js v15åŠä»¥ä¸Šï¼ŒunhandledRejectioné»˜è®¤è¡Œä¸ºæ˜¯ä»€ä¹ˆï¼Ÿæ˜¯å¦é»˜è®¤ç»ˆæ­¢è¿›ç¨‹ï¼Œæˆ–è€…åªæ˜¯è­¦å‘Šï¼Ÿæ ¹æ®Node.jsçš„æ–‡æ¡£ï¼Œåœ¨v15ä¹‹åï¼Œæœªå¤„ç†çš„Promiseæ‹’ç»ä¼šå°†è­¦å‘Šæ‰“å°åˆ°æ§åˆ¶å°ï¼ŒåŒæ—¶è¿›ç¨‹ä»¥éé›¶é€€å‡ºç ç»“æŸã€‚ä¸è¿‡ç”¨æˆ·å¯ä»¥ç›‘å¬process.on('unhandledRejection')æ¥è‡ªå®šä¹‰å¤„ç†ã€‚è€Œæµè§ˆå™¨ä¸ä¼šç»ˆæ­¢è„šæœ¬ï¼Œåªæ˜¯è§¦å‘äº‹ä»¶å’Œé”™è¯¯æ—¥å¿—ã€‚
>
> æ­¤å¤–ï¼Œäº‹ä»¶ç›‘å¬çš„APIä¸åŒï¼ŒNode.jsä½¿ç”¨process.onï¼Œè€Œæµè§ˆå™¨ä½¿ç”¨addEventListenerï¼Œäº‹ä»¶åç§°çš„å¤§å°å†™å¯èƒ½ä¸åŒï¼ˆunhandledRejection vs. unhandledrejectionï¼‰ã€‚
>
> è¿˜éœ€è¦æåˆ°ï¼ŒæŸäº›æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒunhandledrejectionäº‹ä»¶ï¼Œæˆ–è€…åœ¨æ—§ç‰ˆæœ¬ä¸­æœ‰ä¸åŒçš„å®ç°ï¼Œä½†ç°ä»£æµè§ˆå™¨åŸºæœ¬éƒ½æ”¯æŒã€‚è€ŒNode.jsä¸­è¯¥äº‹ä»¶çš„æ”¯æŒæƒ…å†µä»æŸä¸ªç‰ˆæœ¬å¼€å§‹å¯èƒ½æœ‰å˜åŒ–ã€‚
>
> æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘éœ€è¦åˆ†å‡ ä¸ªæ–¹é¢æ¥å¯¹æ¯”ï¼šäº‹ä»¶ç›‘å¬æ–¹å¼ã€é»˜è®¤è¡Œä¸ºã€äº‹ä»¶å‚æ•°ã€å¤„ç†åçš„åç»­äº‹ä»¶ï¼ˆå¦‚rejectionHandledï¼‰ã€ç¯å¢ƒå·®å¼‚çš„å½±å“ç­‰ã€‚åŒæ—¶è¦ç»™å‡ºç¤ºä¾‹ä»£ç ï¼Œè¯´æ˜å¦‚ä½•åœ¨ä¸¤ç§ç¯å¢ƒä¸­æ­£ç¡®ç›‘å¬å’Œå¤„ç†è¿™äº›äº‹ä»¶ã€‚
>
> æœ€åï¼Œå¯èƒ½éœ€è¦æé†’ç”¨æˆ·åœ¨å®é™…å¼€å‘ä¸­åº”å½“å§‹ç»ˆå¤„ç†Promiseçš„æ‹’ç»ï¼Œé¿å…ä¾èµ–ç¯å¢ƒçš„é»˜è®¤è¡Œä¸ºï¼Œä»¥æé«˜ä»£ç çš„å¥å£®æ€§ã€‚å¹¶ä¸”ï¼Œå¯èƒ½è®¨è®ºå¦‚ä½•ä½¿ç”¨lintå·¥å…·æˆ–é…ç½®æ¥å¸®åŠ©æ•è·æœªå¤„ç†çš„æ‹’ç»ï¼Œä»¥å‡å°‘æ½œåœ¨çš„é—®é¢˜ã€‚
>
> 



åœ¨ JavaScript å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œ`unhandledRejection`ï¼ˆæœªå¤„ç†çš„ Promise æ‹’ç»ï¼‰æ˜¯ä¸€ä¸ªå…³é”®é”™è¯¯å¤„ç†æœºåˆ¶ã€‚å°½ç®¡ Node.js å’Œæµè§ˆå™¨å‡éµå¾ª ECMAScript è§„èŒƒå®ç°äº†æ­¤æœºåˆ¶ï¼Œä½†äºŒè€…åœ¨å…·ä½“è¡Œä¸ºä¸Šå­˜åœ¨æ˜¾è‘—å·®å¼‚ã€‚ä»¥ä¸‹æ˜¯è¯¦å°½å¯¹æ¯”ï¼š

---

### **ä¸€ã€æ ¸å¿ƒå·®å¼‚å¯¹ç…§è¡¨**

| **ç‰¹æ€§**               | **Node.js ç¯å¢ƒ**                     | **æµè§ˆå™¨ç¯å¢ƒ**                     |
|-----------------------|-------------------------------------|-----------------------------------|
| **ç›‘å¬æ–¹å¼**          | `process.on('unhandledRejection')` | `window.addEventListener('unhandledrejection')` |
| **é»˜è®¤è¡Œä¸º**          | é»˜è®¤æ‰“å°è­¦å‘Šå¹¶å¯èƒ½å¯¼è‡´è¿›ç¨‹é€€å‡º      | ä»…åœ¨æ§åˆ¶å°æ‰“å°é”™è¯¯ï¼Œä¸å½±å“é¡µé¢è¿è¡Œ  |
| **äº‹ä»¶å‚æ•°ç»“æ„**       | æ¥æ”¶ `(reason, promise)` å‚æ•°       | äº‹ä»¶å¯¹è±¡å« `event.promise` å’Œ `event.reason` |
| **RejectionHandled**  | `process.on('rejectionHandled')`    | æ— åŸç”Ÿå¯¹åº”äº‹ä»¶                     |
| **å¤šçº¿ç¨‹å…¼å®¹æ€§**       | ä¸»çº¿ç¨‹/Worker çº¿ç¨‹å‡è§¦å‘äº‹ä»¶        | ä»…åœ¨ä¸»çª—å£è§¦å‘ï¼ŒWeb Workers å†…ä¸è§¦å‘ |
| **é”™è¯¯è‡ªåŠ¨æ•è·é˜ˆå€¼**   | ç«‹å³ç›‘æµ‹                            | å¯èƒ½çš„å»¶è¿Ÿï¼ˆå—å¾®ä»»åŠ¡é˜Ÿåˆ—å½±å“ï¼‰      |

---

### **äºŒã€è¡Œä¸ºå·®å¼‚æ·±åº¦è§£æ**

#### **1. ç›‘å¬ API è®¾è®¡ä¸äº‹ä»¶è§¦å‘**
- **Node.js**  
  é€šè¿‡è¿›ç¨‹çº§äº‹ä»¶ç›‘å¬ï¼Œéœ€ç»‘å®šåˆ° `process` å¯¹è±¡ï¼š  
  ```javascript
  process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled Rejection at:', promise, 'Reason:', reason);
  });
  ```

- **æµè§ˆå™¨**  
  ä½¿ç”¨ DOM äº‹ä»¶æ¨¡å‹ï¼Œéœ€ç›‘å¬ `window` å¯¹è±¡ï¼š  
  ```javascript
  window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled Rejection:', event.reason);
    event.preventDefault(); // é˜»æ­¢é»˜è®¤æ§åˆ¶å°æŠ¥é”™ï¼ˆæŸäº›åœºæ™¯ä¸‹æœ‰æ•ˆï¼‰
  });
  ```

#### **2. é»˜è®¤è¡Œä¸ºå·®å¼‚**
- **Node.js ç¤ºä¾‹**  
  ```javascript
  // Node.js ä¸­æœªå¤„ç†çš„æ‹’ç»è§¦å‘è­¦å‘Šå¹¶å¯èƒ½ç»ˆæ­¢è¿›ç¨‹
  Promise.reject(new Error('Node.js Rejection'));
  
  /* è¾“å‡ºï¼š
  [WARNING] Unhandled promise rejection. Error: Node.js Rejection
  */
  ```
  > **æ³¨æ„**ï¼š  
  > - **Node < 15**ï¼šç›´æ¥ç»ˆæ­¢è¿›ç¨‹ï¼ˆé€€å‡ºç  1ï¼‰  
  > - **Node â‰¥ 15**ï¼šæ‰“å°è­¦å‘Šä½†ä¸é€€å‡ºï¼Œéœ€æ˜¾å¼é…ç½® `--unhandled-rejections=strict` æ¢å¤ç»ˆæ­¢è¡Œä¸º

- **æµè§ˆå™¨ ç¤ºä¾‹**  
  ```javascript
  // æµè§ˆå™¨ä¸­æœªå¤„ç†çš„æ‹’ç»ä»…æ˜¾ç¤ºé”™è¯¯æ—¥å¿—
  Promise.reject(new Error('Browser Rejection'));
  
  /* è¾“å‡ºï¼š
  Uncaught (in promise) Error: Browser Rejection
  */
  ```

#### **3. `reason` å‚æ•°å¤„ç†**
æµè§ˆå™¨äº‹ä»¶å¯¹è±¡åŒ…è£…åŸå›  (`event.reason`)ï¼Œè€Œ Node.js ç›´æ¥ä¼ é€’åŸå§‹ç†ç”± (`reason`)ã€‚è¿™ä¼šå¯¼è‡´è·¨ç¯å¢ƒä»£ç éœ€ä¸åŒè®¿é—®æ–¹å¼ï¼š
```javascript
// æµè§ˆå™¨éœ€é€šè¿‡ event.reason è·å–æ‹’ç»åŸå› 
window.addEventListener('unhandledrejection', (event) => {
  const stack = event.reason.stack;
});

// Node.js ç›´æ¥è®¿é—® reason å‚æ•°
process.on('unhandledRejection', (reason) => {
  const stack = reason.stack;
});
```

#### **4. é”™è¯¯æ¢å¤ä¸ `rejectionHandled`**
Node.js æä¾›ç‹¬ç‰¹çš„åç»­æ•è·æœºåˆ¶ï¼šè‹¥æœªè¢«å¤„ç†çš„æ‹’ç»åœ¨ç¨åè¢«æ·»åŠ  `.catch()`ï¼Œåˆ™è§¦å‘ `rejectionHandled`ï¼š
```javascript
process.on('rejectionHandled', (promise) => {
  console.log('Rejection handled later:', promise);
});

const promise = Promise.reject(new Error('Delay Catch'));
setTimeout(() => promise.catch(() => {}), 1000);
// å…ˆè§¦å‘ unhandledRejectionï¼Œ1ç§’åè§¦å‘ rejectionHandled
```
æµè§ˆå™¨æ— æ­¤æœºåˆ¶ï¼Œæœªå¤„ç†çš„æ‹’ç»å°†ä¿æŒä¸ºâ€œæœªå¤„ç†â€çŠ¶æ€ã€‚

---

### **ä¸‰ã€å¼€å‘å®æˆ˜å»ºè®®**

#### **1. é€šç”¨æœ€ä½³å®è·µ**
- **å¼ºåˆ¶æ•è·æ‹’ç»**  
  å§‹ç»ˆä¸º Promise é“¾æ·»åŠ  `.catch()`ï¼Œé¿å…ä¾èµ–ç¯å¢ƒé»˜è®¤å¤„ç†ï¼š
  ```javascript
  fetch(url)
    .then(handleData)
    .catch((err) => logError(err)); // æ˜ç¡®å¤„ç†é”™è¯¯
  ```

- **å…¨å±€å…œåº•å¤„ç†**  
  åŒæ—¶é…ç½®ç¯å¢ƒçº§ç›‘å¬ä½œä¸ºæœ€åé˜²çº¿ï¼š
  ```javascript
  // Node.js
  process.on('unhandledRejection', (err) => {
    telemetry.log(err);
    process.exit(1); // ä¸»åŠ¨ç»ˆæ­¢ä»¥é¿å…ä¸ç¡®å®šçŠ¶æ€
  });

  // æµè§ˆå™¨
  window.addEventListener('unhandledrejection', (event) => {
    sendErrorToServer(event.reason);
    event.preventDefault();
  });
  ```

#### **2. ç¯å¢ƒé€‚é…æŠ€å·§**
- **è·¨ç¯å¢ƒå·¥å…·åº“å°è£…**  
  ç¼–å†™å…¼å®¹ Node.js å’Œæµè§ˆå™¨çš„é”™è¯¯å¤„ç†å™¨ï¼š
  ```javascript
  function initUnhandledRejectionHandler() {
    if (typeof process !== 'undefined') {
      process.on('unhandledRejection', handler);
    } else {
      window.addEventListener('unhandledrejection', (e) => handler(e.reason));
    }
  }

  function handler(reason) {
    // ç»Ÿä¸€é”™è¯¯å¤„ç†é€»è¾‘
  }
  ```

- **Linter è¾…åŠ©æ£€æµ‹**  
  é…ç½® ESLint è§„åˆ™ [`@typescript-eslint/no-floating-promises`](https://github.com/typescript-eslint/typescript-eslint/blob/master/packages/eslint-plugin/docs/rules/no-floating-promises.md) ï¼Œå¼ºåˆ¶æ‰€æœ‰ Promise å¿…é¡»è¢«å¤„ç†ã€‚

---

### **å››ã€é«˜çº§åœºæ™¯ï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—å½±å“**
æµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯å­˜åœ¨å¾®ä»»åŠ¡æ£€æŸ¥ç‚¹å·®å¼‚ï¼Œå¯èƒ½å¯¼è‡´ä»¥ä¸‹ç°è±¡ï¼š
```javascript
// æµè§ˆå™¨ä¸­å¯èƒ½çš„å»¶è¿Ÿæ•è·
Promise.reject(new Error('Microtask Queue Impact'));
await new Promise(resolve => setTimeout(resolve, 0));
console.log('This line runs before unhandledrejection');
```
æ­¤æ—¶ `console.log` å¯èƒ½å…ˆäºé”™è¯¯è­¦å‘Šè¾“å‡ºã€‚è€Œ Node.js çš„ `unhandledRejection` åœ¨ Promise æ‹’ç»æ—¶åŒæ­¥è§¦å‘ï¼Œä½¿å¾—æ—¥å¿—é¡ºåºæ›´å¯é¢„æµ‹ã€‚

---

### **æ€»ç»“**  
ç†è§£ `unhandledRejection` åœ¨ Node.js ä¸æµè§ˆå™¨ä¸­çš„è¡Œä¸ºå·®å¼‚ï¼Œèƒ½å¸®åŠ©å¼€å‘è€…ç¼–å†™æ›´å¥å£®çš„å¼‚æ­¥ä»£ç ã€‚æ ¸å¿ƒåŸåˆ™æ˜¯ **ç¯å¢ƒé€‚é… + ä¸»åŠ¨é˜²å¾¡** ï¼šé€šè¿‡æ˜¾å¼é”™è¯¯å¤„ç†å’Œå…¨å±€ç›‘å¬ï¼Œç»“åˆç¯å¢ƒç‰¹æ€§åˆ¶å®šåº”å¯¹ç­–ç•¥ã€‚
