> ğŸ’­ å¥½çš„ï¼Œç”¨æˆ·æƒ³è¦äº†è§£å¦‚ä½•å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ `Promise.map` å‡½æ•°æ¥æ§åˆ¶å¹¶å‘æ•°ã€‚é¦–å…ˆï¼Œæˆ‘éœ€è¦æ˜ç¡®ç”¨æˆ·çš„éœ€æ±‚ï¼šä»–ä»¬éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿå¤„ç†æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ é€šè¿‡å¼‚æ­¥å‡½æ•°ï¼Œä½†å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡æœ‰é™åˆ¶çš„å·¥å…·å‡½æ•°ã€‚ç±»ä¼¼ `Promise.all`ï¼Œä½†éœ€è¦é™åˆ¶åŒæ—¶è¿è¡Œçš„ä»»åŠ¡æ•°é‡ï¼Œé˜²æ­¢åŒæ—¶å¯åŠ¨è¿‡å¤šçš„å¼‚æ­¥æ“ä½œï¼Œæ¯”å¦‚åŒæ—¶å‘å¤ªå¤šè¯·æ±‚å¯¼è‡´æœåŠ¡å™¨å‹åŠ›è¿‡å¤§ã€‚
>
> å¯èƒ½ç”¨æˆ·å·²ç»çŸ¥é“å¦‚ä½•ä½¿ç”¨ Promise.allï¼Œä½†åœ¨é¢å¯¹å¤§é‡ä»»åŠ¡æ—¶é‡åˆ°äº†æ€§èƒ½é—®é¢˜ï¼Œæˆ–è€…æƒ³ä¼˜åŒ–èµ„æºä½¿ç”¨ã€‚è¿™æ—¶å€™ï¼Œæ§åˆ¶å¹¶å‘æ•°å°±å˜å¾—é‡è¦ã€‚è€Œ`Promise.map`å¯èƒ½å¹¶ä¸æ˜¯åŸç”Ÿæ”¯æŒçš„ï¼Œéœ€è¦ç”¨æˆ·è‡ªå·±å®ç°ï¼Œæ‰€ä»¥ç”¨æˆ·æƒ³äº†è§£å¦‚ä½•æ„å»ºè¿™æ ·çš„å‡½æ•°ã€‚
>
> æ¥ä¸‹æ¥éœ€è¦ç¡®å®šå®ç°çš„æ–¹æ³•ã€‚å¸¸è§çš„æ–¹æ³•æœ‰ä½¿ç”¨é˜Ÿåˆ—æ¥ç®¡ç†å¹¶å‘ï¼Œæˆ–è€…åˆ©ç”¨å¼‚æ­¥è¿­ä»£çš„æ–¹å¼ã€‚å¯èƒ½éœ€è¦æ‹†åˆ†æ•°ç»„ä¸ºå¤šä¸ªæ‰¹æ¬¡ï¼ŒæŒ‰æ‰¹æ¬¡æ‰§è¡Œã€‚ä½†æ›´ä¼˜é›…çš„æ–¹å¼åº”è¯¥æ˜¯åŠ¨æ€åœ°å¡«å……ä»»åŠ¡ï¼Œæ¯å½“ä¸€ä¸ªä»»åŠ¡å®Œæˆï¼Œå°±ç«‹å³å¯åŠ¨ä¸‹ä¸€ä¸ªï¼Œç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚è¿™ç§æ–¹æ³•æ›´é«˜æ•ˆï¼Œå› ä¸ºä¸éœ€è¦ç­‰å¾…æ•´ä¸ªæ‰¹æ¬¡å®Œæˆï¼Œè€Œæ˜¯å°½å¯èƒ½ä¿æŒæœ€å¤§å¹¶å‘æ•°è¿è¡Œã€‚
>
> å…·ä½“å®ç°çš„è¯ï¼Œåº”è¯¥è€ƒè™‘ä»¥ä¸‹æ­¥éª¤ï¼š
>
> 1. åˆ›å»ºä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼Œè®°å½•æ‰€æœ‰å¾…å¤„ç†çš„ä»»åŠ¡ã€‚
>
> 2. åˆå§‹åŒ–ä¸€å®šæ•°é‡çš„å¹¶å‘ä»»åŠ¡ï¼Œæ•°é‡ç”±ç”¨æˆ·æŒ‡å®šã€‚
>
> 3. æ¯å½“ä¸€ä¸ªä»»åŠ¡å®Œæˆï¼ˆæ— è®ºæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰ï¼Œå°±ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œã€‚
>
> 4. ä½¿ç”¨ Promise æ¥è·Ÿè¸ªæ‰€æœ‰ä»»åŠ¡çš„å®Œæˆæƒ…å†µï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæ¯•ã€‚
>
> 5. å¤„ç†æ¯ä¸ªä»»åŠ¡çš„é”™è¯¯ï¼Œå¯èƒ½éœ€è¦æ”¶é›†æ‰€æœ‰ç»“æœæˆ–é”™è¯¯ï¼ŒæŒ‰ç…§åŸæ•°ç»„çš„é¡ºåºè¿”å›ã€‚
>
> æ­¤å¤–ï¼Œè¿˜è¦è€ƒè™‘ç»“æœæ”¶é›†çš„æ–¹å¼ã€‚ä¸ºäº†ä¿æŒç»“æœçš„é¡ºåºä¸åŸæ•°ç»„ä¸€è‡´ï¼Œéœ€è¦ç¡®ä¿æ¯ä¸ªä»»åŠ¡çš„ç»“æœå­˜æ”¾åœ¨æ­£ç¡®çš„ä½ç½®ã€‚å¯ä»¥é‡‡ç”¨ç´¢å¼•è¿½è¸ªçš„æ–¹å¼ï¼Œå­˜å‚¨æ¯ä¸ªä»»åŠ¡çš„ç»“æœåˆ°å¯¹åº”çš„ä½ç½®ã€‚
>
> å¯èƒ½éœ€è¦æ³¨æ„çš„é—®é¢˜åŒ…æ‹¬ï¼š
>
> - ä»»åŠ¡çš„åŠ¨æ€æ·»åŠ ï¼Œç¡®ä¿ä»»ä½•æ—¶å€™å¹¶å‘æ•°ä¸è¶…è¿‡è®¾å®šçš„æœ€å¤§å€¼ã€‚
>
> - é”™è¯¯å¤„ç†ä¸ä¸­æ–­æ•´ä¸ªæµç¨‹ï¼Œå…è®¸å…¶ä»–ä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼Œé™¤éç”¨æˆ·å¸Œæœ›åœ¨æŸäº›æƒ…å†µä¸‹åœæ­¢ã€‚
>
> - æœ€ç»ˆè¿”å›çš„ Promise åº”è¯¥æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆå resolveï¼Œæˆ–è€…åœ¨å‡ºç°é”™è¯¯æ—¶ rejectã€‚æˆ–è€…æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œæ”¶é›†æ‰€æœ‰é”™è¯¯å’Œç»“æœã€‚
>
> å‚è€ƒç°æœ‰çš„åº“å¦‚ `bluebird` çš„ `Promise.map` æˆ–è€… `p-limit` çš„å®ç°å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚ä½†ç”¨æˆ·å¸Œæœ›è‡ªå·±å®ç°ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦å°†å…¶æ‹†è§£ä¸ºåŸºæœ¬çš„éƒ¨åˆ†ã€‚
>
> ä»£ç ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š
>
> å®šä¹‰ä¸€ä¸ªå‡½æ•° `promiseMap`ï¼Œæ¥æ”¶æ•°ç»„ã€å¹¶å‘å¤„ç†å‡½æ•°å’Œå¹¶å‘æ•°ã€‚å‡½æ•°è¿”å›ä¸€ä¸ª Promiseï¼Œå½“æ‰€æœ‰ä»»åŠ¡å®Œæˆæ—¶ resolveã€‚å†…éƒ¨ä½¿ç”¨ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç»´æŠ¤æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æ•°é‡ï¼Œå¹¶é€šè¿‡å¾ªç¯æˆ–é€’å½’å¯åŠ¨æ–°ä»»åŠ¡ã€‚å¯èƒ½éœ€è¦ä½¿ç”¨é—­åŒ…æ¥è¿½è¸ªç´¢å¼•å’Œç»“æœæ•°ç»„ã€‚
>
> ç¤ºä¾‹ä»£ç æ–¹å‘ï¼š
>
> - åˆ©ç”¨ Promise é“¾å¼è°ƒç”¨ï¼Œæ¯æ¬¡ä»»åŠ¡å®Œæˆæ—¶æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å‰©ä½™ä»»åŠ¡ï¼Œå¯åŠ¨æ–°çš„ä»»åŠ¡ã€‚
>
> - ä½¿ç”¨æ•°ç»„çš„ reduce æ–¹æ³•æ¥é€æ­¥å¯åŠ¨ä»»åŠ¡ï¼Œç¡®ä¿ä¸è¶…è¿‡å¹¶å‘é™åˆ¶ã€‚
>
> - æˆ–è€…ä½¿ç”¨å¾ªç¯å’Œasync/awaitç»“åˆï¼Œæ›´ç›´è§‚åœ°æ§åˆ¶æµç¨‹ã€‚
>
> å¦å¤–ï¼Œéœ€è¦æ³¨æ„å¦‚ä½•å¤„ç†ä»»åŠ¡ä¸­çš„é”™è¯¯ã€‚é€šå¸¸æœ‰ä¸¤ç§æ–¹å¼ï¼šä¸€ç§æ˜¯è®©é”™è¯¯å¯¼è‡´æ•´ä¸ª map ç»ˆæ­¢ï¼Œå¦ä¸€ç§æ˜¯æ”¶é›†æ‰€æœ‰é”™è¯¯å¹¶æœ€ç»ˆè¿”å›ã€‚æ ¹æ®éœ€æ±‚ï¼Œå¯èƒ½ç”¨æˆ·éœ€è¦ç±»ä¼¼ `Promise.all` çš„è¡Œä¸ºï¼Œå³ä¸€æ—¦æœ‰é”™è¯¯ç«‹å³æ‹’ç»ï¼Œæˆ–æ˜¯ç±»ä¼¼ `Promise.allSettled`ï¼Œç­‰æ‰€æœ‰ä»»åŠ¡å®Œæˆåå†å¤„ç†ç»“æœã€‚ç”¨æˆ·å¯èƒ½éœ€è¦é…ç½®è¿™ä¸ªé€‰é¡¹ï¼Œä½†æ ¹æ®é—®é¢˜çš„æè¿°ï¼Œä¸»è¦è¦æ±‚æ˜¯æ§åˆ¶å¹¶å‘æ•°ï¼Œæ‰€ä»¥å¯èƒ½æš‚ä¸”ä»…æ”¶é›†æ‰€æœ‰ç»“æœï¼Œæˆ–è€…åœ¨é”™è¯¯æ—¶ç«‹å³åœæ­¢ï¼Ÿ
>
> å¯ä»¥é‡‡ç”¨ç±»ä¼¼ `Promise.all` çš„è¡Œä¸ºï¼Œå³å½“ä»»ä½•ä»»åŠ¡å¤±è´¥æ—¶ï¼Œæ•´ä¸ª `Promise.map`ç«‹å³å¤±è´¥ï¼Œä½†ä¿ç•™æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡ç»“æœã€‚æˆ–è€…ç»§ç»­æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ï¼Œä½†æœ€ç»ˆæ±‡æ€»é”™è¯¯ã€‚è¿™ç‚¹éœ€è¦ç¡®è®¤ç”¨æˆ·çš„æ„å›¾ã€‚
>
> åœ¨ä»£ç ç¤ºä¾‹ä¸­ï¼Œå¯èƒ½éœ€è¦æ ¹æ®éœ€æ±‚ä¼ å…¥ä¸€ä¸ªå¤„ç†å‡½æ•°ï¼Œæ¯ä¸ªå…ƒç´ éƒ½ä¼šè¢«è¿™ä¸ªå‡½æ•°å¤„ç†ï¼Œè½¬åŒ–ä¸º Promiseã€‚ç„¶åå¹¶å‘æ‰§è¡Œè¿™äº› Promiseï¼Œä½†ä¸è¶…è¿‡è®¾å®šçš„å¹¶å‘æ•°ã€‚
>
> ç»¼ä¸Šæ‰€è¿°ï¼Œä»£ç å®ç°æ­¥éª¤å¯èƒ½ä¸ºï¼š
>
> 1. åˆ›å»ºä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œå°†åŸå§‹æ•°ç»„è½¬åŒ–ä¸ºä»»åŠ¡åˆ—è¡¨ï¼Œå¹¶è®°å½•æ¯ä¸ªä»»åŠ¡çš„ç´¢å¼•ã€‚
>
> 2. åˆå§‹åŒ–ä¸€å®šæ•°é‡çš„å¹¶å‘æ‰§è¡Œï¼Œä¾‹å¦‚é€šè¿‡å¾ªç¯å¯åŠ¨æœ€å¤šå¹¶å‘æ•°çš„å·¥ä½œå™¨ã€‚
>
> 3. æ¯ä¸ªå·¥ä½œå™¨æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå¤„ç†å¯¹åº”å…ƒç´ ï¼Œè®°å½•ç»“æœåˆ°ç»“æœæ•°ç»„çš„æ­£ç¡®ä½ç½®ã€‚
>
> 4. å½“ä¸€ä¸ªä»»åŠ¡å®Œæˆåï¼Œå¦‚æœè¿˜æœ‰å‰©ä½™ä»»åŠ¡ï¼Œç»§ç»­å¯åŠ¨æ–°ä»»åŠ¡ï¼Œä¿æŒå¹¶å‘æ•°ã€‚
>
> 5. å½“æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œæœ€ç»ˆè¿”å›ç»“æœæ•°ç»„ã€‚
>
> 6. è‹¥ä»»ä½•ä»»åŠ¡å¤±è´¥ï¼Œç«‹å³æ‹’ç»æ•´ä¸ªPromiseï¼Œå¯é€‰æ˜¯å¦éœ€è¦å–æ¶ˆå…¶ä»–æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼ˆä½†é€šå¸¸æ— æ³•å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„Promiseï¼Œåªèƒ½å¿½ç•¥åç»­ç»“æœï¼‰ã€‚
>
> ä½†å¦‚ä½•å®ç°è¿™äº›æ­¥éª¤å‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼š
>
> å‡è®¾å¹¶å‘æ•°ä¸º2ï¼Œæ•°ç»„æœ‰5ä¸ªå…ƒç´ ã€‚é¦–å…ˆå¯åŠ¨ä»»åŠ¡1å’Œä»»åŠ¡2ã€‚å½“ä»»åŠ¡1å®Œæˆï¼Œå¯åŠ¨ä»»åŠ¡3ï¼›ä»»åŠ¡2å®Œæˆåï¼Œå¯åŠ¨ä»»åŠ¡4ï¼Œç­‰ç­‰ã€‚ç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚
>
> å®ç°æ–¹å¼å¯èƒ½æœ‰ï¼š
>
> - ä½¿ç”¨å¾ªç¯å¯åŠ¨åˆå§‹çš„nä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡è¿”å›ä¸€ä¸ªPromiseï¼Œè¿™äº›Promiseåœ¨å®Œæˆæ—¶é€’å½’å¯åŠ¨æ–°ä»»åŠ¡ï¼Œç›´è‡³é˜Ÿåˆ—ä¸ºç©ºã€‚
>
> - æˆ–è€…ä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆè·Ÿè¸ªå½“å‰å¤„ç†åˆ°æ•°ç»„çš„å“ªä¸ªä½ç½®ï¼Œæ¯å½“æœ‰ä»»åŠ¡å®Œæˆï¼Œå°±å¤„ç†ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œç›´åˆ°å¤„ç†å®Œæ‰€æœ‰å…ƒç´ ã€‚
>
> æ¯”å¦‚ï¼Œå¯ä»¥è¿™æ ·åšï¼š
>
> æ•°ç»„çš„æ¯ä¸ªå…ƒç´ è¢«ä¾æ¬¡å¤„ç†ï¼Œç»´æŠ¤ä¸€ä¸ªå½“å‰ç´¢å¼•ã€‚åˆå§‹æ—¶å¯åŠ¨å¹¶å‘æ•°ä¸ªä»»åŠ¡ã€‚æ¯å½“ä¸€ä¸ªä»»åŠ¡å®Œæˆï¼Œå¤„ç†ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ å¤„ç†å®Œæ¯•ã€‚å¹¶ç”¨ä¸€ä¸ªè®¡æ•°å™¨æ¥è·Ÿè¸ªæœ‰å¤šå°‘ä»»åŠ¡åœ¨å¤„ç†ä¸­ï¼Œç¡®ä¿ä¸è¶…è¿‡å¹¶å‘æ•°ã€‚
>
> å¯èƒ½çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š
>
> ```javascript
>
> function promiseMap(array, mapper, concurrency = Infinity) {
>
>   return new Promise((resolve, reject) => {
>
>     const results = [];
>
>     let currentIndex = 0;
>
>     let activeCount = 0;
>
>     let completed = 0;
>
>     const len = array.length;
>
>     if (len === 0) {
>
>       resolve(results);
>
>       return;
>
>     }
>
>     concurrency = Math.min(concurrency, len);
>
>     function next() {
>
>       while (activeCount < concurrency && currentIndex < len) {
>
>         const index = currentIndex++;
>
>         activeCount++;
>
>         const item = array[index];
>
>         Promise.resolve(mapper(item, index, array))
>
>           .then(result => {
>
>             results[index] = result;
>
>           })
>
>           .catch(err => {
>
>             reject(err); // ä¸€æ—¦æœ‰ä¸€ä¸ªé”™è¯¯ï¼Œæ•´ä¸ªæµç¨‹åœæ­¢
>
>           })
>
>           .finally(() => {
>
>             activeCount--;
>
>             completed++;
>
>             if (completed === len) {
>
>               resolve(results);
>
>             } else {
>
>               next();
>
>             }
>
>           });
>
>       }
>
>     }
>
>     next();
>
>   });
>
> }
>
> ```
>
> ä¸è¿‡è¿™ä¸ªä»£ç å¯èƒ½åœ¨å‡ºç°é”™è¯¯æ—¶å¯¼è‡´åé¢çš„ä»»åŠ¡ä¾ç„¶ç»§ç»­æ‰§è¡Œï¼Œæˆ–è€…å¯èƒ½æ— æ³•æ­£ç¡®åœæ­¢ã€‚ä¾‹å¦‚ï¼Œå½“æŸä¸ªä»»åŠ¡å¤±è´¥æ—¶è°ƒç”¨ `reject`ï¼Œä½†ä¹‹åå…¶ä»–ä»»åŠ¡å¯èƒ½è¿˜åœ¨æ‰§è¡Œï¼Œå¯¼è‡´ `resolve` è¢«è°ƒç”¨ä¸¤æ¬¡ã€‚
>
> è¿™ä¸ªé—®é¢˜éœ€è¦å¤„ç†ï¼Œé˜²æ­¢åœ¨é”™è¯¯å‘ç”Ÿåç»§ç»­æ‰§è¡Œä»»åŠ¡ã€‚è¦å¦‚ä½•ç»ˆæ­¢åç»­çš„ä»»åŠ¡ï¼Ÿ
>
> å¯èƒ½éœ€è¦åœ¨å‡ºç°é”™è¯¯æ—¶è®°ä½å·²ç»è§¦å‘rejectï¼Œåç»­æ“ä½œä¸å†è¿›è¡Œã€‚è¿™å°±éœ€è¦å¼•å…¥ä¸€ä¸ªæ ‡å¿—å˜é‡ï¼Œæ¯”å¦‚ `isRejected`ï¼Œä¸€æ—¦åœ¨ä»»ä½•ä¸€ä¸ªä»»åŠ¡ä¸­æ•è·åˆ°é”™è¯¯ï¼Œå°±å°†è¿™ä¸ªæ ‡å¿—è®¾ä¸ºtrueï¼Œå¹¶åœ¨æ‰§è¡Œåç»­çš„ä»£ç æ—¶è·³è¿‡ã€‚
>
> å› æ­¤ï¼Œæ”¹è¿›åçš„ä»£ç å¦‚ä¸‹ï¼š
>
> ```javascript
>
> function promiseMap(array, mapper, concurrency = Infinity) {
>
>   return new Promise((resolve, reject) => {
>
>     const results = new Array(array.length);
>
>     let currentIndex = 0;
>
>     let activeCount = 0;
>
>     let completedCount = 0;
>
>     let isRejected = false;
>
>     if (array.length === 0) {
>
>       resolve(results);
>
>       return;
>
>     }
>
>     concurrency = Math.min(concurrency, array.length);
>
>     const next = () => {
>
>       if (isRejected) return;
>
>       while (activeCount < concurrency && currentIndex < array.length) {
>
>         const index = currentIndex++;
>
>         activeCount++;
>
>         const item = array[index];
>
>         Promise.resolve()
>
>           .then(() => mapper(item, index, array))
>
>           .then(result => {
>
>             results[index] = result;
>
>           })
>
>           .catch(error => {
>
>             isRejected = true;
>
>             reject(error);
>
>           })
>
>           .finally(() => {
>
>             activeCount--;
>
>             completedCount++;
>
>             if (isRejected) return;
>
>             if (completedCount === array.length) {
>
>               resolve(results);
>
>             } else {
>
>               next();
>
>             }
>
>           });
>
>       }
>
>     };
>
>     next();
>
>   });
>
> }
```
>
> è¿™æ ·ï¼Œå½“ä»»ä½•ä¸€ä¸ªä»»åŠ¡å‡ºé”™æ—¶ï¼Œ`isRejected`ä¼šè¢«è®¾ç½®ä¸ºtrueï¼Œåç»­ä»»åŠ¡ä¸å†å¤„ç†ã€‚å¹¶ä¸”ï¼Œä¸€æ—¦æ•è·åˆ°é”™è¯¯ç«‹å³è°ƒç”¨`reject`ï¼Œå…¶ä»–çš„æ­£åœ¨å¤„ç†ä¸­çš„ä»»åŠ¡å¯èƒ½è¿˜æ²¡æœ‰å®Œæˆï¼Œä½†ä»ç„¶ä¼šç»§ç»­ï¼Œä½†ä»–ä»¬çš„æœ€åå¤„ç†ä¼šå› ä¸º`isRejected`ä¸ºtrueè€Œä¸å†æ‰§è¡Œä»»ä½•å¯èƒ½å¯¼è‡´`resolve`æˆ–`reject`çš„é€»è¾‘ã€‚
>
> å¦ä¸€ä¸ªé—®é¢˜æ˜¯åœ¨é”™è¯¯å¤„ç†ä¸­ï¼Œå¦‚æœmapperå‡½æ•°æœ¬èº«è¿”å›çš„æ˜¯ä¸€ä¸ªåŒæ­¥é”™è¯¯ï¼Œéœ€è¦è¢«æ­£ç¡®æ•è·ã€‚å› æ­¤åœ¨`Promise.resolve().then(() => mapper(...))`ï¼Œå¯ä»¥ç¡®ä¿mapperä¸­çš„åŒæ­¥é”™è¯¯è¢«è½¬æ¢ä¸ºæ‹’ç»çš„Promiseã€‚
>
> æ­¤æ—¶ï¼Œmapperå‡½æ•°çš„æ¯ä¸ªè°ƒç”¨è¢«åŒ…è£¹åœ¨Promiseä¸­ï¼Œç¡®ä¿è¿”å›çš„æ— è®ºæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥é”™è¯¯éƒ½èƒ½è¢«catchæ•è·ã€‚
>
> å¯¹äºç»“æœçš„æ”¶é›†ï¼Œåœ¨.thenæ—¶æŠŠç»“æœå­˜å…¥resultsæ•°ç»„çš„å¯¹åº”ä½ç½®ï¼Œä»¥ä¿æŒé¡ºåºæ­£ç¡®ã€‚è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºä»»åŠ¡çš„å®Œæˆé¡ºåºå¯èƒ½ä¸åŒäºåŸæ•°ç»„çš„é¡ºåºï¼Œæ¯”å¦‚å¦‚æœå¹¶å‘æ•°ä¸º2ï¼Œç¬¬ä¸€ä¸ªä»»åŠ¡å¦‚æœå…ˆå®Œæˆï¼Œç¬¬ä¸‰ä¸ªä»»åŠ¡çš„ç»“æœä¼šè¢«æ”¾åœ¨ç´¢å¼•2çš„ä½ç½®ã€‚
>
> è‡³æ­¤ï¼Œè¿™ä¸ªå‡½æ•°çš„åŸºæœ¬ç»“æ„èƒ½å¤Ÿå¤„ç†æ§åˆ¶å¹¶å‘æ•°çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ä¸”åœ¨ä»»ä¸€ä»»åŠ¡å¤±è´¥æ—¶ç«‹å³æ‹’ç»ï¼ŒåŒæ—¶ä¿æŒç»“æœçš„é¡ºåºã€‚
>
> å¦‚æœéœ€è¦å…è®¸ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œå¹¶åœ¨æœ€åæ”¶é›†æ‰€æœ‰ç»“æœï¼ˆä¸ç®¡æ˜¯å¦å‡ºé”™ï¼‰ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ç±»ä¼¼`Promise.allSettled`çš„æ–¹å¼ï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦åœ¨æ¯ä¸ªä»»åŠ¡å®Œæˆæ—¶ï¼Œæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½è®°å½•ç»“æœæˆ–é”™è¯¯ï¼Œå¹¶ä¸”åªåœ¨æ‰€æœ‰ä»»åŠ¡å®Œæˆåresolveã€‚ä½†æ ¹æ®åŸå§‹é—®é¢˜æè¿°ï¼Œç”¨æˆ·å¯èƒ½å¸Œæœ›å®ç°ç±»ä¼¼`Promise.all`çš„è¡Œä¸ºï¼Œæ‰€ä»¥å½“å‰çš„å®ç°æ–¹å¼æ˜¯æ­£ç¡®çš„ã€‚
>
> ç°åœ¨ï¼Œæµ‹è¯•è¿™ä¸ªå‡½æ•°æ˜¯å¦æ­£ç¡®ï¼š
>
> ä¾‹å¦‚ï¼Œè®¾å®šå¹¶å‘æ•°ä¸º2ï¼Œæ‰§è¡Œä¸‰ä¸ªä»»åŠ¡ï¼š
>
> ```javascript
>
> const array = [1, 2, 3];
>
> promiseMap(array, async (num) => {
>
>   await new Promise(resolve => setTimeout(resolve, 100));
>
>   return num * 2;
>
> }, 2).then(console.log).catch(console.error);
>
> ```
>
> é¢„æœŸç»“æœåº”è¯¥æ˜¯[2,4,6]ï¼Œå¹¶ä¸”å‰ä¸¤ä¸ªä»»åŠ¡å‡ ä¹åŒæ—¶å¼€å§‹ï¼Œç¬¬ä¸‰ä¸ªä»»åŠ¡åœ¨ç¬¬ä¸€ä¸ªæˆ–ç¬¬äºŒä¸ªå®Œæˆåå¼€å§‹ã€‚
>
> å¦å¤–æµ‹è¯•é”™è¯¯æƒ…å†µï¼š
>
> ```javascript
>
> promiseMap([1, 2, 3], async (num) => {
>
>   if (num === 2) throw new Error('fail');
>
>   return num * 2;
>
> }, 2).then(console.log).catch(e => console.log(e.message)); // æœŸæœ›è¾“å‡º 'fail'
>
> ```
>
> å½“å¤„ç†å…ƒç´ 2æ—¶æŠ›å‡ºé”™è¯¯ï¼Œå…¶ä»–ä»»åŠ¡å¯èƒ½å·²ç»å¯åŠ¨ä½†ä¼šè¢«å¿½ç•¥ï¼Œæˆ–è€…åœ¨å‘ç”Ÿé”™è¯¯çš„æ—¶å€™é˜»æ­¢ç»§ç»­å¤„ç†åç»­ä»»åŠ¡ï¼Œå·²ç»å¯åŠ¨çš„ä»»åŠ¡ä»ä¼šç»§ç»­ï¼Œä½†ä¸ä¼šå½±å“ç»“æœï¼Œæœ€ç»ˆåªè§¦å‘ä¸€æ¬¡rejectã€‚
>
> æ­¤æ—¶éœ€è¦æ³¨æ„å½“é”™è¯¯å‘ç”Ÿæ—¶ï¼Œæ˜¯å¦åº”è¯¥ç»ˆæ­¢å…¶ä»–æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Ÿä½†æ ¹æ®å½“å‰çš„ä»£ç ï¼Œå·²å¯åŠ¨çš„ä»»åŠ¡ä¾ç„¶ä¼šç»§ç»­æ‰§è¡Œï¼Œåªæ˜¯ç»“æœä¸ä¼šè¢«å¤„ç†åçš„Promiseå…³å¿ƒã€‚ä¸è¿‡ï¼Œä¸€æ—¦è§¦å‘rejectä¹‹åï¼Œåç»­çš„æ›´æ–°ä¸ä¼šè§¦å‘resolveæˆ–rejectï¼Œå› ä¸ºå®ƒä»¬ä¼šæ£€æŸ¥is_Rejectedçš„æ ‡è®°ã€‚
>
> è¿™å¯èƒ½å°±æ˜¯ç”¨æˆ·æ‰€éœ€è¦çš„ï¼Œå› ä¸ºä¸€æ—¦æœ‰ä¸€ä¸ªé”™è¯¯ï¼Œæ•´ä½“è§†ä¸ºå¤±è´¥ï¼Œè¿”å›é”™è¯¯ï¼Œè€Œå…¶ä»–å·²ç»åœ¨è¿è¡Œçš„ä»»åŠ¡æ— æ³•åœæ­¢ï¼Œæ‰€ä»¥å®ƒä»¬å¯èƒ½ç»§ç»­æ‰§è¡Œå®Œæ¯•ï¼Œä½†å®é™…ä¸Šç»“æœå·²è¢«å¿½ç•¥ã€‚åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œåº”ç”¨å¯èƒ½éœ€è¦å¤„ç†å¯èƒ½çš„å‰¯ä½œç”¨ï¼Œä¾‹å¦‚æ—¥å¿—è®°å½•æˆ–å…¶ä»–èµ„æºçš„å ç”¨ï¼Œè¿™æ˜¯ç”¨æˆ·éœ€è¦æ³¨æ„çš„ã€‚
>
> å¦å¤–ï¼Œéœ€è¦æ³¨æ„å¦‚æœmapperå‡½æ•°è¿”å›çš„æ˜¯åŒæ­¥è€Œéå¼‚æ­¥ä»»åŠ¡ï¼Œæ¯”å¦‚ï¼š
>
> ```javascript
>
> promiseMap([1,2,3], (num) => {
>
>   if(num === 1) throw new Error('sync error');
>
>   return num *2;
>
> }, 2).catch(e => console.log(e.message)); // åº”è¯¥è¾“å‡º 'sync error'
>
> ```
>
> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•è·è¿™ä¸ªåŒæ­¥é”™è¯¯æ˜¯å¦æœ‰æ•ˆï¼Ÿ
>
> åœ¨ä»£ç ä¸­ï¼Œmapperçš„æ‰§è¡Œæ˜¯è¢«åŒ…è£¹åœ¨Promise.resolve().then(() => ...)ä¸­çš„ï¼Œè¿™æ ·å³ä½¿åŒæ­¥æŠ›é”™ï¼Œä¼šè¢«è½¬æ¢ä¸ºæ‹’ç»çš„Promiseï¼Œå› æ­¤catchä¼šæ•è·åˆ°ã€‚
>
> è¿™æ ·çœ‹èµ·æ¥ï¼Œå½“å‰çš„å®ç°èƒ½å¤„ç†åŒæ­¥å’Œå¼‚æ­¥é”™è¯¯ã€‚
>
> æœ€åï¼Œè¿™æ ·çš„å®ç°æ˜¯å¦è€ƒè™‘äº†å¹¶å‘æ§åˆ¶çš„æ­£ç¡®æ€§ï¼Ÿ
>
> æœ€å¼€å§‹çš„å¯åŠ¨é˜¶æ®µä¼šå¯åŠ¨concurrencyæ•°é‡çš„ä»»åŠ¡ã€‚å½“æ¯ä¸ªä»»åŠ¡å®Œæˆæ—¶ï¼Œä¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šçš„ä»»åŠ¡éœ€è¦å¯åŠ¨ã€‚å› ä¸ºactiveCountåœ¨æ¯ä¸ªä»»åŠ¡å¼€å§‹æ—¶å¢åŠ ï¼Œä»»åŠ¡å®Œæˆåå‡å°‘ï¼Œå¹¶é€šè¿‡è¿ç»­çš„next()è°ƒç”¨æ¥å¯åŠ¨æ–°çš„ä»»åŠ¡ï¼Œç›´åˆ°currentIndexåˆ°è¾¾æ•°ç»„æœ«å°¾ã€‚
>
> å› æ­¤ï¼Œè¿™ç§åŠ¨æ€å¡«å……çš„æ–¹å¼èƒ½å¤Ÿåœ¨ä»»ä½•æ—¶å€™æœ€å¤šå¹¶å‘concurrencyæ•°é‡çš„ä»»åŠ¡ï¼Œè€Œæ— éœ€é¢„å…ˆæ‹†åˆ†æ‰¹æ¬¡ã€‚
>
> æ€»ç»“è¿™ä¸ªå®ç°çš„æ–¹æ³•æ˜¯å¯è¡Œçš„ï¼Œç”¨æˆ·æƒ³è¦çš„å¹¶å‘æ§åˆ¶å¾—ä»¥å®ç°ã€‚
>
> 



---

å®ç°æ”¯æŒå¹¶å‘æ§åˆ¶çš„ `Promise.map` å¯ä» **é˜Ÿåˆ—è°ƒåº¦ + åŠ¨æ€ç»­å¡«** è§’åº¦è®¾è®¡ã€‚ä»¥ä¸‹ä¸ºå®ç°ä»£ç ã€ä½¿ç”¨åœºæ™¯å’ŒåŸç†å‰–æï¼š

---

### **ä¸€ã€åŠŸèƒ½ä»£ç å®ç°**
#### æ ¸å¿ƒç‰¹å¾
- **æ§åˆ¶å¹¶å‘æ± **ï¼šæœ€å¤šåŒæ—¶è¿è¡Œ N ä¸ªå¼‚æ­¥ä»»åŠ¡
- **é¡ºåºä¿çœŸ**ï¼šç»“æœæŒ‰åŸå§‹æ•°ç»„é¡ºåºè¿”å›
- **é”™è¯¯æ‹¦æˆª**ï¼šä»»æ„ä»»åŠ¡å¤±è´¥ç«‹å³ç»ˆæ­¢ï¼ˆç±»ä¼¼ Promise.allï¼‰
- **æ™ºèƒ½è°ƒåº¦**ï¼šä»»åŠ¡å®Œæˆä¸€ä¸ªï¼Œè‡ªåŠ¨è¡¥ä½æ–°ä»»åŠ¡

```javascript
function promiseMap(arr, mapper, concurrency = Infinity) {
  return new Promise((resolve, reject) => {
    const results = new Array(arr.length); // ç»“æœé¡ºåºå®¹å™¨
    let activeCount = 0;                   // è¿è¡Œä¸­çš„ä»»åŠ¡æ•°
    let currentIndex = 0;                  // å½“å‰å¤„ç†å…ƒç´ çš„æŒ‡é’ˆ
    let isRejected = false;                // å…¨å±€ç»ˆæ­¢æ ‡å¿—

    const next = () => {
      // ç»ˆæ­¢æ¡ä»¶ï¼šå…¨å±€é”™è¯¯æˆ–ä»»åŠ¡å·²æ¸…ç©º
      if (isRejected || currentIndex >= arr.length) return;

      // å¯åŠ¨æ–°ä»»åŠ¡çš„æ¡ä»¶ï¼šå½“å‰æ´»è·ƒæ•° < å¹¶å‘æ•°
      while (activeCount < concurrency && currentIndex < arr.length) {
        const index = currentIndex++; // è®°å½•åŸå§‹ä½ç½®
        activeCount++; 

        Promise.resolve(arr[index])
          .then((item) => mapper(item, index, arr))
          .then((result) => {
            results[index] = result; // æŒ‰ç´¢å¼•å­˜å‚¨ç»“æœ
          })
          .catch((err) => {
            isRejected = true;
            reject(err);             // å…¨å±€æŠ¥é”™
          })
          .finally(() => {
            activeCount--;
            if (!isRejected) {
              if (++completedCount === arr.length) {
                resolve(results);    // å…¨éƒ¨å®Œæˆ
              } else {
                next();              // ç»­å¡«æ–°ä»»åŠ¡
              }
            }
          });
      }
    };

    let completedCount = 0; 
    if (arr.length === 0) return resolve(results);
    concurrency = Math.min(concurrency, arr.length);
    next(); // å¯åŠ¨åˆå§‹æ‰¹æ¬¡
  });
}
```

---

### **äºŒã€ä½¿ç”¨ç¤ºä¾‹**
#### 1. åŸºç¡€ç”¨æ³•ï¼ˆé™åˆ¶å¹¶å‘æ•°ï¼‰
```javascript
// æ¨¡æ‹Ÿå¼‚æ­¥ä»»åŠ¡ï¼ˆè€—æ—¶éšæœºï¼‰
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

promiseMap([1, 2, 3, 4], async (num) => {
  await sleep(Math.random() * 1000);
  return num * 2;
}, 2).then(console.log); // [2,4,6,8]
```

#### 2. é”™è¯¯å¤„ç†
```javascript
promiseMap([5, 0, 8], async (num) => {
  if (num === 0) throw new Error('Division by zero');
  return 10 / num;
}, 2)
  .then(console.log)
  .catch(err => console.error(err.message)); // "Division by zero"
```

#### 3. å¹¶å‘æ€§èƒ½ç›‘æ§
é€šè¿‡ `console.log` è§‚å¯Ÿæ´»è·ƒä»»åŠ¡æ•°çš„æ³¢åŠ¨ï¼š
```javascript
const tracker = { active: 0 };

promiseMap(new Array(10).fill(null), async (_, i) => {
  tracker.active++; 
  console.log(`Start ${i} | Active: ${tracker.active}`);
  await sleep(1000);
  tracker.active--;
}, 3);

// è¾“å‡ºç¤ºä¾‹ï¼š
// Start 0 | Active: 1
// Start 1 | Active: 2
// Start 2 | Active: 3
// (1ç§’å) Start 3 | Active: 3
```

---

### **ä¸‰ã€å®ç°åŸç†è§£æ**
#### æ ¸å¿ƒé€»è¾‘æµç¨‹å›¾
```
åˆå§‹åŒ– â†’ å¯åŠ¨åˆå§‹å¹¶å‘ä»»åŠ¡ â†’ ä»»åŠ¡å®Œæˆ â†’ æ˜¯å¦å…¨éƒ¨å®Œæˆï¼Ÿ â†’ æ˜¯ â†’ è¿”å›ç»“æœ
                â†³ å¦ â†’ ç»­å¡«æ–°ä»»åŠ¡ï¼ˆåŠ¨æ€å¾ªç¯ï¼‰â†²
```

#### å…³é”®æŠ€æœ¯ç‚¹
1. **é˜Ÿåˆ—åŠ¨æ€ç»­å¡«**  
   é€šè¿‡ `while (activeCount < concurrency)` å®æ—¶ç›‘è§†å¹¶å‘æ± ï¼Œç©ºé—²æ—¶ç«‹å³è¡¥ä½æ–°ä»»åŠ¡ï¼Œç¡®ä¿æœ€é«˜æ•ˆåˆ©ç”¨å¹¶å‘é¢åº¦ã€‚

2. **æŒ‰ç´¢å¼•å­˜å‚¨ç»“æœ**  
   åˆ©ç”¨é—­åŒ…ç¼“å­˜ `index`ï¼Œç¡®ä¿å³ä½¿åå‘ä»»åŠ¡å…ˆå®Œæˆï¼Œç»“æœä»æŒ‰åŸå§‹é¡ºåºæ’åˆ—ã€‚

3. **é”™è¯¯ç†”æ–­æœºåˆ¶**  
   è®¾ç½® `isRejected` æ ‡å¿—ä½ï¼Œä»»ä½•ä»»åŠ¡å¤±è´¥ç«‹å³åœæ­¢åç»­ä»»åŠ¡ï¼Œé¿å…æ— æ•ˆè®¡ç®—ã€‚

4. **ä»»åŠ¡çŠ¶æ€è®¡æ•°å™¨**  
   `activeCount` æ§åˆ¶å¹¶å‘æ± æ°´ä½ï¼Œ`completedCount` åˆ¤æ–­æ•´ä½“å®Œæˆåº¦ã€‚

---

### **å››ã€ä¸åŒæ–¹æ¡ˆçš„å¯¹æ¯”**
#### å¸¸è§å®ç°æ–¹æ¡ˆåŠç¼ºé™·

| æ–¹æ¡ˆ               | ä¼˜åŠ¿                      | ç¼ºé™·                     |
|-------------------|-------------------------|-------------------------|
| **åˆ†æ‰¹æ¬¡å…¨é‡æ‰§è¡Œ**  | å®ç°ç®€å•                | å¹¶å‘æ•°å¯èƒ½æ³¢åŠ¨ï¼ˆå¦‚æŸæ‰¹æ¬¡è€—æ—¶è¿‡é•¿ï¼‰|
| **é€’å½’é“¾å¼è°ƒç”¨**    | åŠ¨æ€è°ƒåº¦æ•ˆç‡é«˜           | ä»£ç å¤æ‚åº¦é«˜ï¼Œæ˜“æ ˆæº¢å‡º      |
| **Worker çº¿ç¨‹æ± **  | é€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡      | Node.js ç¯å¢ƒå¤æ‚ï¼Œæµè§ˆå™¨ä¸æ”¯æŒ |

#### æœ¬æ–‡æ–¹æ¡ˆä¼˜åŠ¿
- **åŠ¨æ€æ°´ä½æ§åˆ¶**ï¼šå§‹ç»ˆè·‘æ»¡å¹¶å‘é¢åº¦
- **æ— é€’å½’é£é™©**ï¼šç”¨å¾ªç¯æ›¿ä»£é€’å½’ï¼Œé¿å…æ ˆæº¢å‡º
- **è½»é‡æ— ä¾èµ–**ï¼šçº¯ Promise å®ç°ï¼Œå…¼å®¹æµè§ˆå™¨/Node.js

---

### **äº”ã€æ‰©å±•åœºæ™¯**
#### 1. ä»»åŠ¡è¶…æ—¶æ§åˆ¶
```javascript
// ä¸ºæ¯ä¸ªä»»åŠ¡æ·»åŠ è¶…æ—¶é€»è¾‘
promiseMap(urls, async (url) => {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 5000);

  const response = await fetch(url, { signal: controller.signal });
  clearTimeout(timeout);
  return response.json();
}, 4);
```

#### 2. è¿›åº¦åé¦ˆ
```javascript
// é€šè¿‡äº‹ä»¶å‘å°„å™¨åé¦ˆè¿›åº¦
const emitter = new EventEmitter();
let processed = 0;

promiseMap(files, async (file) => {
  await upload(file);
  emitter.emit('progress', ++processed);
}, 3);

emitter.on('progress', (count) => {
  console.log(`å·²ä¸Šä¼  ${count}/${files.length}`);
});
```

#### 3. çªç ´æµè§ˆå™¨è¿æ¥é™åˆ¶
```javascript
// Chrome å¯¹åŒåŸŸåæœ€å¤š 6 ä¸ªå¹¶å‘ HTTP è¿æ¥
// é€šè¿‡ Promise.map è°ƒæ•´ä¸º 3 ä¸ªå¹¶å‘ä¸‹è½½
promiseMap(downloadUrls, (url) => {
  return new Promise((resolve) => {
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = url;
    iframe.onload = resolve;
    document.body.appendChild(iframe);
  });
}, 3);
```

---

### **æ€»ç»“**
æ­¤ `promiseMap` å®ç°æ–¹æ¡ˆåœ¨ä»£ç ç²¾ç®€æ€§ã€æ‰§è¡Œæ•ˆç‡ã€é¡ºåºä¿çœŸä¸‰è€…é—´è¾¾åˆ°å¹³è¡¡ã€‚å»ºè®®ç»“åˆå…·ä½“åœºæ™¯è°ƒæ•´é”™è¯¯å¤„ç†ç­–ç•¥ï¼ˆå¦‚æ›¿æ¢ `
